<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RXI â€¢ Painel SERMulher RS (CÃ³digo completo)</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  /* Define o tamanho base de 1rem = 16px */
  html {
    font-size: 100%; /* 100% do tamanho padrÃ£o do navegador (geralmente 16px) */
  }

  :root{
    --roxo:#64376e; --lilas:#9169a5; --pb80:#333; --pb40:#777;
    --bg:#fff; --text:#222; --card:#fff; --border:#e8e2ef; --shadow:0.0rem 0.125rem 0.625rem rgba(100,55,110,.08); /* Convertido */
    --blue:#174181; --error:#9b1c1c; --ok:#1aa36f; --warn:#e6a100;
    --toast-bg:rgba(34,34,34,.92); --toast-text:#fff; --focus:#baa4cc;
    --grp-mama:#8b5bd1; --grp-utero:#64376e; --grp-geral:#4a7bd6;
    --orange:#ff8d2b;
  }

  *{box-sizing:border-box}
  /* 18px / 16px = 1.125rem */
  body{margin:0;background:var(--bg);color:var(--text);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;font-size:1.125rem;}

  /* HEADER claro sempre */
  header{
    background:#fff; color:#222; border-bottom:0.125rem solid var(--roxo); /* Convertido */
    display:flex;align-items:center;justify-content:space-between;gap:0.75rem; /* Convertido */
    padding:0.75rem 1rem;flex-wrap:wrap; box-shadow:var(--shadow); /* Convertido */
    position: sticky; top:0; z-index:1000;
  }
  .brand{display:flex;align-items:center;gap:0.75rem} /* Convertido */
  .brand img{height:5.25rem;width:auto} /* Convertido */
  /* 24px / 16px = 1.5rem */
  .brand h1{margin:0;color:var(--roxo);font-weight:800;font-size:1.5rem;letter-spacing:.0125rem} /* Convertido */

  main{max-width:100rem;margin:1.125rem auto;padding:0 1rem 8.75rem} /* Convertido */
  .card{
   border:0.0625rem solid var(--border); /* Convertido */
  border-radius:0.75rem; /* Convertido */
  padding:1rem; /* Convertido */
  background:#fff;
  box-shadow:var(--shadow); padding:0.875rem 1rem; margin-bottom:1rem; transition:transform .15s /* Convertido */
  }
  .card:hover{transform:translateY(-0.125rem)} /* Convertido */
  .card h2{
  margin:-1rem -1rem 0.75rem; /* Convertido */
  padding:0.625rem 0.875rem; /* Convertido */
  background:var(--roxo);
  color:#fff;
  /* 18px / 16px = 1.125rem */
  font-size:1.125rem;
  border-radius:0.75rem 0.75rem 0 0; /* Convertido */
}
  .badge-step{
    display:inline-flex;align-items:center;justify-content:center;
    width:1.625rem;height:1.625rem;border-radius:999px;font-weight:800;/* 13px / 16px = 0.8125rem */font-size:0.8125rem;
    background:color-mix(in srgb, var(--roxo) 14%, #ffffff);
    color:var(--roxo); border:0.0625rem solid color-mix(in srgb, var(--roxo) 40%, #ffffff); /* Convertido */
  }

  /* 13px / 16px = 0.8125rem */
  label{display:block;font-size:0.8125rem;color:var(--pb80);margin:0 0 0.375rem} /* Convertido */
  input,select,textarea{
    width:100%;padding:0.625rem 0.75rem;border:0.0625rem solid var(--border);border-radius:0.625rem;background:#fff;color:#222;/* 15px / 16px = 0.9375rem */font-size:0.9375rem;outline:none;
    transition:border-color .15s, box-shadow .15s
  }
  input:focus,select:focus,textarea:focus{border-color:var(--lilas);box-shadow:0 0 0 0.1875rem color-mix(in srgb, var(--lilas) 35%, transparent)} /* Convertido */
  textarea{min-height:7.5rem;resize:vertical} /* Convertido */
  #saida{min-height:25rem} /* Convertido */
  .row{display:flex;flex-wrap:wrap;gap:0.75rem} /* Convertido */
  .row.end{align-items:flex-end}
  .field{flex:1 1 16.25rem;min-width:15rem} /* Convertido */
  /* 12px / 16px = 0.75rem */
  .muted{color:var(--pb40);font-size:0.75rem}
  .pill-group{display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.5rem} /* Convertido */
  .pill{position:relative;display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;border-radius:999px;border:0.0625rem solid var(--border);background:#fcfbfe;color:var(--roxo);cursor:pointer;user-select:none;transition:.15s;/* 15px / 16px = 0.9375rem */font-size:0.9375rem}
  .pill:hover{background:var(--lilas);color:#fff}
  .pill input{position:absolute;opacity:0;pointer-events:none}
  .pill.active{background:var(--roxo);color:#fff;border-color:transparent}
  .pill.err{outline:0.125rem solid var(--error)} /* Convertido */
  .chip{display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 0.625rem;border-radius:999px;background:#eee7f5;color:#452357;border:0.0625rem solid rgba(0,0,0,.06);cursor:pointer;user-select:none;/* 13px / 16px = 0.8125rem */font-size:0.8125rem;font-weight:700}
  .chip[data-active="true"]{background:linear-gradient(145deg,#805d91,#6b4780);color:#fff;border-color:transparent}

  .actions{display:flex;flex-wrap:wrap;gap:0.625rem;margin-top:0.625rem} /* Convertido */
  button{display:inline-flex;align-items:center;gap:0.625rem;cursor:pointer;border:0;border-radius:0.625rem;padding:0.625rem 0.875rem;font-weight:800;letter-spacing:.0125rem;transition:filter .15s, background .2s, color .2s, border-color .2s} /* Convertido */
  button:focus-visible{outline:0.1875rem solid var(--focus);outline-offset:0.125rem} /* Convertido */
  button:hover{filter:brightness(1.03)}
  .btn{background:var(--roxo);color:#fff}
  .btn-sec{background:var(--lilas);color:#fff}
  .btn-ghost{background:transparent;color:var(--roxo);border:0.0625rem solid var(--roxo)} /* Convertido */
  .btn-orange{background:var(--orange);color:#fff}
  .btn-done{background:var(--ok) !important;color:#fff !important;border-color:var(--ok) !important}

  .btn-gercon{background:#fff;color:var(--blue);border:0.0625rem solid var(--blue);box-shadow:0.375rem 0.375rem 0.75rem rgba(0,0,0,.08),-0.375rem -0.375rem 0.75rem #fff} /* Convertido */
  .btn-gercon:hover{background:#f0f6ff;color:#0e2a50;box-shadow:inset 0.25rem 0.25rem 0.5rem rgba(0,0,0,.06), inset -0.25rem -0.25rem 0.5rem #fff} /* Convertido */
  .btn-gercon img{height:1.125rem;display:block} /* Convertido */
  .outbox{display:grid;grid-template-columns:1fr;gap:0.75rem} /* Convertido */
  /* 13px / 16px = 0.8125rem */
  .counter{font-size:0.8125rem}
  .danger{color:var(--error)}
  .toolbar{display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap} /* Convertido */

  .switch{--h:1.75rem;position:relative;display:inline-flex;align-items:center;gap:0.625rem;background:#fff;border:0.0625rem solid var(--border);border-radius:0.75rem;padding:0.375rem 0.625rem;cursor:pointer} /* Convertido */
  .switch input{position:absolute;opacity:0;pointer-events:none}
  .switch .track{width:3.25rem;height:var(--h);background:#e7e0ef;border-radius:999px;position:relative;flex:0 0 auto;transition:background .2s} /* Convertido */
  .switch .thumb{position:absolute;top:0.1875rem;left:0.1875rem;width:1.375rem;height:1.375rem;border-radius:50%;background:#fff;box-shadow:0 0.125rem 0.375rem rgba(0,0,0,.2);transition:left .2s} /* Convertido */
  .switch.on .track{background:linear-gradient(90deg,var(--lilas),var(--roxo))}
  .switch.on .thumb{left:1.6875rem} /* Convertido */
  /* 12px / 16px = 0.75rem */
  .switch .label{font-size:0.75rem;color:var(--pb80);font-weight:700;letter-spacing:.0125rem;white-space:nowrap}

  .group-bar{position:sticky;top:9.125rem;z-index:900;background:color-mix(in srgb, var(--card) 85%, transparent);backdrop-filter:saturate(1.2) blur(6px);border:0.0625rem solid var(--border);border-radius:0.75rem;padding:0.5rem;margin:-0.25rem 0 0.5rem 0;display:flex;flex-wrap:wrap;gap:0.5rem;align-items:center} /* Convertido */
  /* 12px / 16px = 0.75rem */
  .gbtn{background:#fff;color:#222;border:0.125rem solid var(--border);padding:0.375rem 0.625rem;border-radius:999px;font-weight:800;font-size:0.75rem;cursor:pointer}
  .gbtn[data-group="mama"]{border-color:var(--grp-mama)} .gbtn[data-group="utero"]{border-color:var(--grp-utero)} .gbtn[data-group="geral"]{border-color:var(--grp-geral)}
  .gbtn.active{box-shadow:inset 0 0 0 0.125rem currentColor} /* Convertido */
  .gbtn .dot{display:inline-block;width:0.625rem;height:0.625rem;border-radius:50%;margin-right:0.375rem;vertical-align:-0.0625rem} /* Convertido */
  .gbtn[data-group="mama"] .dot{background:var(--grp-mama)} .gbtn[data-group="utero"] .dot{background:var(--grp-utero)} .gbtn[data-group="geral"] .dot{background:var(--grp-geral)}
  .pill[data-group="mama"]{border-color:color-mix(in srgb, var(--grp-mama) 65%, #fff)} .pill[data-group="utero"]{border-color:color-mix(in srgb, var(--grp-utero) 65%, #fff)} .pill[data-group="geral"]{border-color:color-mix(in srgb, var(--grp-geral) 65%, #fff)}

  .step-head{display:flex;align-items:center;gap:0.625rem;margin:0.25rem 0 0.375rem} /* Convertido */
  /* 14px / 16px = 0.875rem */
  .step-head .title{font-weight:800;color:var(--roxo);font-size:0.875rem;letter-spacing:.0125rem}

  .routebar{position:sticky;top:4.25rem;z-index:920;border:0.0625rem dashed var(--border);border-radius:0.75rem;padding:0.5rem 0.625rem;margin:-0.125rem 0 0.75rem;background:color-mix(in srgb, var(--card) 85%, transparent);backdrop-filter:saturate(1.2) blur(6px);display:flex;flex-wrap:wrap;gap:0.5rem;align-items:center;justify-content:space-between} /* Convertido */
  /* 14px / 16px = 0.875rem */
  .routebar .summary{font-size:0.875rem} .routebar .summary strong{color:var(--roxo)} /* 12px / 16px = 0.75rem */.routebar .why{font-size:0.75rem;color:var(--pb40)}
  .k{display:inline-flex;gap:0.375rem;align-items:center;padding:0.25rem 0.5rem;border-radius:999px;border:0.0625rem solid var(--border);background:#fff;/* 12px / 16px = 0.75rem */font-size:0.75rem} /* Convertido */

  .alertbar{position:sticky;top:7.5rem;z-index:950;background:#fff3f3;border:0.0625rem solid #ffc9c9;border-left:0.375rem solid var(--error);border-radius:0.625rem;padding:0.625rem 0.75rem;margin-bottom:0.75rem} /* Convertido */
  .alertbar h3{margin:0 0 0.25rem;color:var(--error);/* 15px / 16px = 0.9375rem */font-size:0.9375rem} /* Convertido */
  .alertbar ul{margin:0.375rem 0 0 1.375rem} .alertbar li{margin-bottom:0.25rem} /* Convertido */
  .alert-actions{display:flex;gap:0.5rem;margin-top:0.5rem} /* Convertido */
  .disabled{opacity:.45;pointer-events:none}

  .drawer{position:fixed;inset:0 0 0 auto;width:min(35rem,96vw);background:var(--card);border-left:0.0625rem solid var(--border);box-shadow:-0.75rem 0 1.75rem rgba(0,0,0,.25);transform:translateX(110%);transition:transform .25s ease;z-index:980;padding:0.875rem 1rem;overflow:auto} /* Convertido */
  .drawer.show{transform:translateX(0)}
  .drawer h3{margin:0 0 0.5rem;color:var(--roxo);/* 18px / 16px = 1.125rem */font-size:1.125rem;font-weight:800}
  .chips{display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.625rem} /* Convertido */

  .toast{position:fixed;left:50%;bottom:1.375rem;transform:translateX(-50%);background:var(--toast-bg);color:var(--toast-text);padding:0.625rem 0.875rem;border-radius:0.625rem;/* 14px / 16px = 0.875rem */font-size:0.875rem;opacity:0;pointer-events:none;transition:opacity .25s,transform .25s;z-index:9999} /* Convertido */
  .toast.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(-0.25rem)} /* Convertido */

  /* FABs lado direito (Base legal + topo/fim) */
  .fab{position:fixed;right:1rem;bottom:1rem;display:flex;flex-direction:column;gap:0.5rem;z-index:950} /* Convertido */
  .fab button{border-radius:999px;box-shadow:var(--shadow)}
  #btn-legal{background:var(--roxo);color:#fff;border:0;padding:0.625rem 0.75rem} /* Convertido */
  /* Setas: sempre visÃ­veis com 50% de opacidade, 100% no hover/foco */
  .navbtn{width:2.875rem;height:2.875rem;display:flex;align-items:center;justify-content:center;border:0.125rem solid var(--roxo);background:rgba(100,55,110,.06);color:var(--roxo);opacity:.5} /* Convertido */
  .navbtn:hover,.navbtn:focus-visible{opacity:1}
  /* 24px / 16px = 1.5rem */
  .navbtn span{font-size:1.5rem;font-weight:800;line-height:1}

  /* CrÃ©ditos */
  footer{max-width:100rem;margin:0 auto 2.5rem;padding:0 1rem} /* Convertido */
  /* 13.5px / 16px = 0.84375rem */
  .credits{font-size:0.84375rem;color:#555;border-top:0.0625rem dashed var(--border);padding-top:0.625rem} /* Convertido */

  /* PDF helper */
  .pdf-row{display:flex;gap:0.625rem;align-items:center;flex-wrap:wrap} /* Convertido */
  .pdf-row .field{min-width:20rem;flex:1} /* Convertido */
  .pdf-row button{flex:0 0 auto}
  @media (min-width:56.25rem){ .pdf-row{flex-wrap:nowrap} } /* Convertido */
  /* 12px / 16px = 0.75rem */
  .pdf-status{font-size:0.75rem;color:#555;margin-top:0.25rem} /* Convertido */

/* ==== TOASTS COLORIDOS RXI ==== */
.toast {
  position: fixed;
  bottom: 1.25rem; /* Convertido */
  right: 1.25rem; /* Convertido */
  padding: 0.75rem 1.125rem; /* Convertido */
  border-radius: 0.5rem; /* Convertido */
  /* 14px / 16px = 0.875rem */
  font-size: 0.875rem;
  font-weight: 500;
  color: #fff;
  box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,0.25); /* Convertido */
  opacity: 0;
  transform: translateY(1.25rem); /* Convertido */
  transition: opacity 0.4s ease, transform 0.4s ease;
  z-index: 9999;
}
.toast.show { opacity: 1; transform: translateY(0); }
.toast.success { background: #1aa36f; }
.toast.warning { background: #e6a100; }
.toast.error   { background: #c0392b; }
.toast.info    { background: #174181; }

/* ==== GUIA INTERATIVO RXI ==== */
#guia-rxi {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.6);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:10000;
}
.guia-box {
  background:#fff;
  color:#222;
  padding:1.25rem; /* Convertido */
  border-radius:0.625rem; /* Convertido */
  max-width:31.25rem; /* Convertido */
  text-align:center;
  box-shadow:0 0.375rem 1.25rem rgba(0,0,0,0.3); /* Convertido */
}
.guia-box h3 { margin-top:0; }
.guia-btns { margin-top:1.25rem; } /* Convertido */
.guia-btns button {
  margin:0 0.5rem; /* Convertido */
  padding:0.5rem 0.875rem; /* Convertido */
  border:none;
  border-radius:0.375rem; /* Convertido */
  cursor:pointer;
  font-weight:600;
  /* 14px / 16px = 0.875rem */
  font-size:0.875rem;
}
.btn-prev { background:#777; color:#fff; }
.btn-next { background:#64376e; color:#fff; }
.btn-close { background:#c0392b; color:#fff; }


/* RXI switch styles */
.switch{--h:1.75rem;position:relative;display:inline-flex;align-items:center;gap:0.625rem;background:#fff;border:0.125rem solid color-mix(in srgb, var(--roxo) 20%, var(--border));border-radius:0.75rem;padding:0.375rem 0.625rem;cursor:pointer;box-shadow:0 0.125rem 0.625rem rgba(100,55,110,.08)} /* Convertido */
.switch-input{position:absolute;opacity:0;pointer-events:none}
.switch-track{width:3.25rem;height:var(--h);background:#e7e0ef;border-radius:999px;position:relative;flex:0 0 auto;transition:background .2s,box-shadow .2s;border:0.0625rem solid color-mix(in srgb, var(--roxo) 20%, var(--border));box-shadow:inset 0 0.125rem 0.375rem rgba(0,0,0,.10)} /* Convertido */
.switch-thumb{position:absolute;top:0.1875rem;left:0.1875rem;width:1.375rem;height:1.375rem;border-radius:50%;background:#fff;box-shadow:0 0.125rem 0.5rem rgba(0,0,0,.25);transition:left .2s,box-shadow .2s} /* Convertido */
.switch-input:checked+.switch-track{background:linear-gradient(90deg,var(--lilas),var(--roxo));box-shadow:inset 0 0.125rem 0.375rem rgba(0,0,0,.12),0 0 0 0.1875rem rgba(100,55,110,.25)} /* Convertido */
.switch-input:checked+.switch-track .switch-thumb{left:1.6875rem;box-shadow:0 0.125rem 0.625rem rgba(0,0,0,.30),0 0 0 0.375rem rgba(100,55,110,.20)} /* Convertido */
/* 12px / 16px = 0.75rem */
.switch-label{font-size:0.75rem;color:var(--pb80);font-weight:700;letter-spacing:.0125rem;white-space:nowrap}
/* Highlight only this toggle */
#filterToggle+.switch-track{background:#e4daf0;border:0.0625rem solid #bda6d3} /* Convertido */
#filterToggle:checked+.switch-track{background:linear-gradient(90deg,#5d2a6b,#9169a5);border-color:transparent;box-shadow:inset 0 0.125rem 0.375rem rgba(0,0,0,.12),0 0 0 0.1875rem rgba(100,55,110,.28)} /* Convertido */
#filterToggle+.switch-track .switch-thumb{box-shadow:0 0.125rem 0.375rem rgba(0,0,0,.28)} /* Convertido */
#filterToggle:checked+.switch-track .switch-thumb{left:1.8125rem;box-shadow:0 0.125rem 0.625rem rgba(0,0,0,.30),0 0 0 0.375rem rgba(100,55,110,.18)} /* Convertido */
#filterToggle~.switch-label{color:#6b6280;font-weight:700}
#filterToggle:checked~.switch-label{color:#5d2a6b}


/* Ajustes de sobreposiÃ§Ã£o do VLibras */
.vw-access-button { z-index: 99999 !important; }
.vw-plugin-wrapper { z-index: 99998 !important; }
</style>
</head>
<!-- VLibras: Widget de Acessibilidade em Libras -->
<div vw class="enabled">
  <div vw-access-button class="active"></div>
  <div vw-plugin-wrapper>
    <div class="vw-plugin-top-wrapper"></div>
  </div>
</div>


<!-- Guia em etapas RXI -->
<div id="guia-rxi">
  <div class="guia-box">
    <h3 id="guia-titulo">ğŸ“– Bem-vindo ao sistema RXI</h3>
    <p id="guia-texto">Este Ã© o sistema de Toasts RXI. Ele exibe notificaÃ§Ãµes rÃ¡pidas para feedback visual.</p>
    <div class="guia-btns">
      <button class="btn-prev" onclick="guiaAnterior()" disabled>â—€ Voltar</button>
      <button class="btn-next" onclick="guiaProximo()">PrÃ³ximo â–¶</button>
      <button class="btn-close" onclick="fecharGuia()">âœ– Fechar</button>
    </div>
  </div>
</div>

<header>
  <div class="brand">
    <img src="https://raw.githubusercontent.com/receitailustrada/rxi-imagens/refs/heads/main/logo-SERMulher%20RS.png" alt="SERMulher RS">
    <h1> ğŸ“±Painel de Encaminhamento â€¢ Cruz Alta</h1>
  </div>
  <div class="toolbar"> <!-- Este div agora agrupa o switch e os botÃµes -->
    <div class="switch" id="switch-upper" role="switch" aria-checked="true">
      <div class="track"><div class="thumb"></div></div>
      <span class="label">ğŸ”¡ GERCON ğŸ” </span>
      <input type="checkbox" id="upper" checked />
    </div>

    <button id="copy" class="btn-sec" title="Copiar texto">ğŸ“‹ Copiar</button>
    <button id="clear" class="btn-orange" title="Limpar e reiniciar">Limpar ğŸ§¹ reiniciar</button>
    <button id="gercon" class="btn-gercon" title="FORMATAR">
      <img src="https://raw.githubusercontent.com/receitailustrada/rxi-imagens/a043cf565f03f16245b013c07d27b2a15e1af2eb/logo-gercon.svg" alt="GERCON">
      FORMATAR
    </button>
  </div>
</header>

<main id="topo">

  <!-- ETAPA 1 -->
  <div class="step-head"><span class="badge-step">1</span><span class="title">Destino sugerido (explicaÃ§Ã£o)</span></div>
  <section class="routebar" id="routebar">
    <div class="summary">
      <strong>Destino sugerido:</strong> <span id="route-dest">SERMulher RS</span>
      <span class="k" id="route-prio" style="display:none"></span>
      <span class="k" id="route-risk" style="display:none"></span>
      <div class="why" id="route-why"></div>
    </div>
    <!-- Removido aqui o switch + "Aplicar" (duplicado). Mantido apenas na Etapa 2. -->
  </section>

  <!-- ALERTA -->
  <section id="alert" class="alertbar" style="display:none">
    <h3>âš ï¸ InconsistÃªncias detectadas</h3>
    <ul id="alert-list"></ul>
    <div class="alert-actions" id="alert-actions">
      <button id="fix-auto" class="btn">Corrigir automaticamente</button>
      <button id="no-ref" class="btn-sec" style="display:none">Explicar risco e manter na APS (nÃ£o encaminhar)</button>
      <button id="dismiss" class="btn-ghost">Ignorar (nÃ£o recomendado)</button>
    </div>
    <div class="muted">Com inconsistÃªncias ativas, as aÃ§Ãµes de GERCON/Copiar ficam desabilitadas.</div>
  </section>

  <!-- ETAPA 2 -->
  <section class="card step" id="etapa-2">
    <h2><span class="badge-step">2</span> IdentificaÃ§Ã£o & Linha de cuidado</h2>
    <div class="row">
      <div class="field">
        <label>Nome completo (opcional)</label>
        <input id="nome" placeholder="NÃ£o armazenamos dados ğŸ”">
      </div>
      <div class="field">
        <label>Data do encaminhamento</label>
        <input id="data" type="date"><div class="muted">Data do dia (editÃ¡vel).</div>
      </div>
      <div class="field">
        <label>Data de nascimento</label>
        <input id="dob" type="date" />
        <div class="muted">A idade Ã© calculada automaticamente.</div>
      </div>
      <div class="field">
        <label>Idade (automÃ¡tico)</label>
        <input id="idade" type="text" readonly placeholder="â€”">
      </div>

      <div class="field">
        <label>Linha de cuidado (eixo oficial)</label>
        <select id="linha">
          <option value="Colo do Ãštero">Colo do Ãštero</option>
          <option value="Mama">Mama</option>
          <option value="Endometriose / Miomatose">Endometriose / Miomatose</option>
          <option value="Planejamento Reprodutivo (Infertilidade)">Planejamento Reprodutivo (Infertilidade)</option>
          <option value="ClimatÃ©rio">ClimatÃ©rio</option>
        </select>
        <div class="muted">Temas de apoio (exemplo: lesÃµes vulvares) aparecem nos botÃµes e campos abaixo.</div>
      </div>

      <div class="field">
        <label>Prioridade (manual)</label>
        <select id="prioridade">
          <option>Rotina ğŸŸ¢</option><option>Preferencial ğŸŸ¡</option><option>UrgÃªncia ambulatorial ğŸ”´</option>
        </select>
      </div>
      <div class="field">
        <label>Destino manual (se desligar a sugestÃ£o)</label>
        <select id="destinoManual">
          <option>SERMulher RS</option><option>UPA 24h</option><option>Hospital</option><option>CAPS</option>
        </select>
      </div>
    </div>

    <div class="row end" style="gap:10px;align-items:center;margin-top:6px">
      <div class="switch" id="sw-age-note" role="switch" aria-checked="false" title="Inserir parÃ¡grafo explicativo por idade">
        <div class="track"><div class="thumb"></div></div>
        <span class="label">Inserir nota de risco por idade para mulheres que desejam gestar</span>
        <input type="checkbox" id="ageNote">
      </div>

      <!-- ÃšNICO local com a automaÃ§Ã£o de destino + botÃ£o aplicar -->
      <div class="switch" id="sw-autoroute-dup" role="switch" aria-checked="true" title="O sistema analisa sinais/achados e sugere o melhor destino (SERMulher, UPA, Hospital). VocÃª pode desligar e escolher manualmente." style="margin-left:8px">
        <div class="track"><div class="thumb"></div></div>
        <span class="label">Sugerir destino automaticamente (RXI)</span>
        <input type="checkbox" id="autoroute-dup" checked>
      </div>

      <button id="apply-route-dup" class="btn-sec">Aplicar no texto</button>
    </div>
  </section>

  <!-- ETAPA 3 -->
  <section class="card step" id="sec-sinais">
    <h2><span class="badge-step">3</span> ClÃ­nica: exames, sinais e sintomas (selecione)</h2>
    <div class="group-bar" aria-label="Filtros de grupo">
      <button class="gbtn active" data-group="all">ğŸ‘ï¸â€ğŸ—¨ï¸ Exibir todos</button>
      <button class="gbtn" data-group="mama"><span class="dot"></span>Queixas da mama</button>
      <button class="gbtn" data-group="utero"><span class="dot"></span>Queixas do Ãºtero/colo</button>
      <button class="gbtn" data-group="geral"><span class="dot"></span>Queixas gerais</button>
    </div>
    <div class="pill-group" id="sinais">
      <!-- Ãštero/colo -->
      <label class="pill" data-group="utero"><input type="checkbox" value="Citologia alterada (ASC-H/AGC/HSIL)">ğŸ§« Citologia alterada (ASC-H/AGC/HSIL)</label>
      <label class="pill" data-group="utero"><input type="checkbox" value="Sangramento uterino anormal">ğŸ©¸ğŸšº Sangramento uterino anormal</label>
      <label class="pill" data-group="utero"><input type="checkbox" value="Sangramento pÃ³s-coital persistente">ğŸ©¸ğŸ” Sangramento pÃ³s-coital persistente</label>
      <label class="pill" data-group="utero"><input type="checkbox" value="Dor pÃ©lvica crÃ´nica">ğŸ’¥ğŸšº Dor pÃ©lvica crÃ´nica</label>
      <!-- Mama -->
      <label class="pill" data-group="mama"><input type="checkbox" value="NÃ³dulo mamÃ¡rio palpÃ¡vel">ğŸ«±ğŸ½â€ğŸ«²ğŸ» NÃ³dulo mamÃ¡rio palpÃ¡vel</label>
      <label class="pill" data-group="mama"><input type="checkbox" value="Descarga papilar sanguinolenta">ğŸ—»ğŸŒ‹ Descarga papilar sanguinolenta</label>
      <label class="pill" data-group="mama"><input type="checkbox" value="Pele em casca de laranja ou retraÃ§Ã£o">ğŸŸ£ Pele em casca de laranja/retraÃ§Ã£o</label>
      <label class="pill" data-group="mama"><input type="checkbox" value="Adenopatia axilar">ğŸŸ£ Adenopatia axilar</label>
      <!-- Gerais / apoio -->
      <label class="pill" data-group="geral"><input type="checkbox" value="Sangramento pÃ³s-menopausa">ğŸ©¸ğŸ‘µ Sangramento pÃ³s-menopausa</label>
      <label class="pill" data-group="geral"><input type="checkbox" value="Sangramento intermenstrual">ğŸ©¸ğŸŒ€ Sangramento intermenstrual</label>
      <label class="pill" data-group="geral"><input type="checkbox" value="Corrimento vaginal fÃ©tido/anormal">ğŸ«¢ğŸ’¦ Corrimento vaginal fÃ©tido/anormal</label>
      <label class="pill" data-group="geral"><input type="checkbox" value="Dor pÃ©lvica aguda">ğŸ’¥ğŸ™â€â™€ï¸ Dor pÃ©lvica aguda</label>
      <label class="pill" data-group="mama"><input type="checkbox" value="Dor mamÃ¡ria focal persistente (â‰¥1 ciclo)">ğŸŸ£ Dor mamÃ¡ria focal (â‰¥1 ciclo)</label>
      <label class="pill" data-group="mama"><input type="checkbox" value="SecreÃ§Ã£o papilar serosa unilateral">ğŸ©¸ SecreÃ§Ã£o papilar serosa unilateral</label>
      <label class="pill" data-group="mama"><input type="checkbox" value="InversÃ£o recente do mamilo">ğŸŸ£ InversÃ£o recente do mamilo</label>
      <label class="pill" data-group="geral"><input type="checkbox" value="Galactorreia">ğŸ§ª Galactorreia</label>
      <label class="pill" data-group="geral"><input type="checkbox" value="Sintomas de climatÃ©rio persistentes apÃ³s manejo na APS">ğŸŒ¡ï¸ ClimatÃ©rio persistente â‰¥6m</label>
      <label class="pill" data-group="geral"><input type="checkbox" value="Suspeita de endometriose ou adenomiose">ğŸŸª Suspeita de endometriose/adenomiose</label>
      <label class="pill" data-group="geral"><input type="checkbox" value="Miomatose com sangramento refratÃ¡rio">ğŸŸª Miomatose com sangramento refratÃ¡rio</label>
      <label class="pill" data-group="geral"><input type="checkbox" value="Prurido vulvar persistente">ğŸŸ£ Prurido vulvar persistente</label>
      <label class="pill" data-group="geral"><input type="checkbox" value="LesÃ£o/ulceraÃ§Ã£o vulvar">ğŸŸ£ LesÃ£o/ulceraÃ§Ã£o vulvar</label>
      <label class="pill" data-group="geral"><input type="checkbox" value="Massa anexial palpÃ¡vel">ğŸŸª Massa anexial palpÃ¡vel</label>
      <label class="pill" data-group="geral"><input type="checkbox" value="Aumento do volume abdominal">ğŸŸª Aumento do volume abdominal</label>
    </div>
  </section>

  <!-- ETAPA 4 -->
  <section class="card step">
    <h2><span class="badge-step">4</span> Exames (realizados/solicitados)</h2>
    <div class="pill-group" id="exames">
      <label class="pill"><input type="checkbox" value="CitopatolÃ³gico cervical">ğŸ§« CitopatolÃ³gico cervical</label>
      <label class="pill"><input type="checkbox" value="Colposcopia">ğŸ”¬ Colposcopia</label>
      <label class="pill"><input type="checkbox" value="BiÃ³psia de colo uterino">ğŸ”¬ BiÃ³psia de colo uterino</label>
      <label class="pill"><input type="checkbox" value="Mamografia">ğŸ©» Mamografia</label>
      <label class="pill"><input type="checkbox" value="Ultrassonografia mamÃ¡ria">ğŸ©» US mamÃ¡ria</label>
      <label class="pill"><input type="checkbox" value="US transvaginal ou pÃ©lvica">ğŸ©» US transvaginal/pÃ©lvica</label>
      <label class="pill"><input type="checkbox" value="RessonÃ¢ncia de mama">ğŸ©» RM de mama</label>
      <label class="pill"><input type="checkbox" value="Î²-hCG sÃ©rico">ğŸ§ª Î²-hCG sÃ©rico</label>
      <label class="pill"><input type="checkbox" value="Hemograma e ferritina">ğŸ§ªğŸŸ¤ Hemograma e ferritina</label>
      <label class="pill"><input type="checkbox" value="Prolactina e TSH">ğŸ§ªğŸ¦‹ Prolactina/TSH</label>
      <label class="pill"><input type="checkbox" value="CA-125">ğŸ§ªğŸ—ï¸ CA-125</label>
      <label class="pill"><input type="checkbox" value="BI-RADS 4 ou 5">âš ï¸ BI-RADS 4/5</label>
    </div>

    <!-- Importador de laudos (PDF/Imagem) -->
    <div class="field" style="margin-top:10px">
      <label>Inserir laudo (PDF/Imagem)</label>
      <div class="pdf-row">
        <div class="field">
          <input id="pdfFile" type="file" accept=".pdf,image/*">
          <div id="pdfStatus" class="pdf-status">Selecione um arquivo para habilitar a leitura.</div>
        </div>
        <button id="pdfRead" class="btn-ghost" type="button" disabled>ğŸ“„ Ler PDF/Imagem</button>
        
      <!-- RXI: Toggle de filtragem (marketing/contatos/rodapÃ©s) -->
      <span id="pdfBadge" class="k" style="display:none">Lido <span id="pdfPages" class="badge-dot">0</span></span>
      </div>
    </div>

    <!-- Campo de texto para o conteÃºdo do PDF e botÃ£o para adicionar ao rascunho -->
    <div class="field" style="margin-top:10px">
      <label>ConteÃºdo extraÃ­do do PDF/Imagem (leitura prÃ©via)</label>
      <textarea id="pdfContentDisplay" readonly placeholder="Texto extraÃ­do do PDF/Imagem. Use o botÃ£o + abaixo para adicionÃ¡-lo Ã s ObservaÃ§Ãµes ClÃ­nicas Item 7. Este conteÃºdo integra o encaminhamento final, limitado a 2000 caracteres. âš ï¸ Edite e ajuste no Item 7 para otimizar."></textarea>
      <button id="addPdfContentToOutput" class="btn-sec" type="button" style="margin-top:8px;" disabled>+ Adicionar texto do PDF ao rascunho</button>
      <div class="muted">Este texto serÃ¡ adicionado ao campo de "ObservaÃ§Ãµes ClÃ­nicas".</div>
    </div>
  </section>

  <!-- ETAPA 5 â€“ EXAME FÃSICO -->
  <section class="card step" id="sec-exame">
    <h2><span class="badge-step">5</span> Exame fÃ­sico (pronto/editar)</h2>

    <div class="row" style="gap:10px;align-items:center">
      <div class="switch" id="sw-inc-exam" role="switch" aria-checked="false" title="Incluir exame fÃ­sico no texto">
        <div class="track"><div class="thumb"></div></div>
        <span class="label">Incluir EF completo no texto final</span>
        <input type="checkbox" id="incExam">
      </div>
      <button id="exam-fill-normal" class="btn-ghost" type="button">âœ… Normal (completo)</button>
      <button id="exam-clear" class="btn-ghost" type="button">ğŸ§¹ Limpar exame</button>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="field" style="min-width:280px">
        <label>Normais (clique para inserir/remover)</label>
        <div class="chips" id="exam-normais">
          <span class="chip" data-key="geral" data-text="Geral: BEG, AAA, hidratada.">Geral</span>
          <span class="chip" data-key="sv" data-text="Sinais vitais estÃ¡veis (PA e FC em valores de referÃªncia).">Sinais vitais</span>
          <span class="chip" data-key="mamas-n" data-text="Mamas: simÃ©tricas, sem retraÃ§Ãµes, pele normal; sem nÃ³dulos palpÃ¡veis; sem descarga papilar.">Mamas normais</span>
          <span class="chip" data-key="axilas-n" data-text="Axilas: sem linfonodomegalias palpÃ¡veis.">Axilas normais</span>
          <span class="chip" data-key="abd-n" data-text="Abdome: plano, flÃ¡cido, indolor Ã  palpaÃ§Ã£o, sem massas palpÃ¡veis.">Abdome normal</span>
          <span class="chip" data-key="esp-n" data-text="Especular: colo rosado, sem lesÃµes visÃ­veis ou sangramento.">Especular normal</span>
          <span class="chip" data-key="toque-n" data-text="Toque bimanual: Ãºtero em volume habitual, mÃ³vel, indolor; anexos livres, sem massas.">Toque bimanual normal</span>
        </div>
      </div>
      <div class="field" style="min-width:280px">
        <label>Alterados (clique para inserir/remover â€¢ edite os colchetes)</label>
        <div class="chips" id="exam-alterados">
          <span class="chip" data-key="mama-nod" data-text="Mama: nÃ³dulo palpÃ¡vel em [quadrante] [lado], ~[2,0] cm, consistÃªncia [firme], [mÃ³vel]/[fixo], [doloroso]/[indolor].">Mama â€“ nÃ³dulo</span>
          <span class="chip" data-key="mama-pele" data-text="Mama: retraÃ§Ã£o cutÃ¢nea em [quadrante]/peau dâ€™orange.">Mama â€“ pele</span>
          <span class="chip" data-key="mama-desc" data-text="Descarga papilar [serosa/sanguinolenta] [unilateral/bilateral].">Mama â€“ descarga</span>
          <span class="chip" data-key="axila-linf" data-text="Axila: linfonodo palpÃ¡vel ~[1,5] cm, [mÃ³vel]/[fixo], [doloroso]/[indolor].">Axila â€“ linfonodo</span>
          <span class="chip" data-key="abd-dor" data-text="Abdome: dor Ã  palpaÃ§Ã£o em [hipogÃ¡strio/quadrante], sem sinais de peritonismo.">Abdome â€“ dor</span>
          <span class="chip" data-key="colo-lesao" data-text="Especular: lesÃ£o [exofÃ­tica/ulcerada] em colo, sangramento ao toque.">Colo â€“ lesÃ£o</span>
          <span class="chip" data-key="toque-dor" data-text="Toque bimanual: dor Ã  mobilizaÃ§Ã£o do colo, [massa anexial] [direita/esquerda].">Toque â€“ dor/massa</span>
        </div>
      </div>
    </div>

    <label style="margin-top:10px">Texto do exame (editÃ¡vel)</label>
    <textarea id="exame-txt" placeholder="Clique nos botÃµes acima para inserir trechos prontos. Clique em limpar para remover. VocÃª pode editar livremente aqui."></textarea>
    <div class="muted">Obs.: use apenas se o exame foi realizado e estÃ¡ registrado â€” por padrÃ£o fica desligado.</div>
  </section>

<!-- ETAPA 6 â€“ MEDICAMENTOS -->
<section class="card step">
  <h2><span class="badge-step">6</span> Medicamentos/condutas </h2>

  <p class="muted" style="margin:0 0 6px"><strong>Fez uso prÃ©vio</strong> (clique para inserir):</p>
  <div class="pill-group" id="meds">
    <label class="pill"><input type="checkbox" value="AnalgÃ©sicos e AINEs otimizados">ğŸ’Š AINEs/analgÃ©sicos</label>
    <label class="pill"><input type="checkbox" value="Anticoncepcional combinado ou progestagÃªnio contÃ­nuo">ğŸ’Š ACO/progestagÃªnio</label>
    <label class="pill"><input type="checkbox" value="DIU liberador de levonorgestrel">âœï¸ DIU-LNG</label>
    <label class="pill"><input type="checkbox" value="Terapia para climatÃ©rio otimizada na APS">ğŸ’Š Terapia para climatÃ©rio</label>
    <label class="pill"><input type="checkbox" value="SuplementaÃ§Ã£o de ferro">ğŸŸ¤ Ferro</label>
    <label class="pill"><input type="checkbox" value="AntibiÃ³tico conforme protocolo">ğŸ¦ ğŸ’Š AntibiÃ³tico (conforme protocolo)</label>
    <label class="pill"><input type="checkbox" value="AnÃ¡logo de GnRH (quando indicado)">ğŸ’Š AnÃ¡logo de GnRH</label>
    <label class="pill"><input type="checkbox" value="Danazol (quando indicado)">ğŸ’Š Danazol</label>
  </div>

  <p class="muted" style="margin:12px 0 6px"><strong>Conduta terapÃªutica atual</strong> (clique para inserir):</p>
  <div class="pill-group" id="meds-dose">
    <!-- AnalgÃ©sicos/AINEs -->
    <label class="pill"><input type="checkbox" value="dipirona 500 mg">ğŸ’Š dipirona 500 mg</label>
    <label class="pill"><input type="checkbox" value="paracetamol 500 mg">ğŸ’Š paracetamol 500 mg</label>
    <label class="pill"><input type="checkbox" value="ibuprofeno 600 mg">ğŸ’Š ibuprofeno 600 mg</label>
    <label class="pill"><input type="checkbox" value="Ã¡cido tranexÃ¢mico 250 mg">ğŸ’Š Ã¡cido tranexÃ¢mico 250 mg</label>
    <label class="pill"><input type="checkbox" value="Ã¡cido tranexÃ¢mico 500 mg">ğŸ’Š Ã¡cido tranexÃ¢mico 500 mg</label>
    <label class="pill"><input type="checkbox" value="Ã¡cido mefenÃ¢mico 500 mg">ğŸ’Š Ã¡cido mefenÃ¢mico 500 mg</label>
    <!-- Gineco/Endometriose/SUA -->
    <label class="pill"><input type="checkbox" value="Levonorgestrel 0,15 mg + Etinilestradiol 0,03 mg 1 CP, VO, 12/12h por 7 dias. Depois 1 CP/dia por 21 dias.">ğŸ’Š levonorgestrel 0,15 mg + etinilestradiol 0,03 mg</label>
    <label class="pill"><input type="checkbox" value="Etinilestradiol 0,05 mg + Levonorgestrel 0,25 mg 1 CP, VO, 12/12h por 7 dias. Depois 1 CP/dia por 21 dias.">ğŸ’Š etinilestradiol 0,05 mg + levonorgestrel 0,25 mg</label>
    <label class="pill"><input type="checkbox" value="Etinilestradiol 0,02 mg + Desogestrel 0,15 mg 1 CP, VO, 12/12h por 7 dias. Depois 1 CP/dia por 21 dias.">ğŸ’Š etinilestradiol 0,02 mg + desogestrel 0,15 mg</label>
    <label class="pill"><input type="checkbox" value="Etinilestradiol 0,03 mg + Desogestrel 0,15 mg 1 CP, VO, 12/12h por 7 dias. Depois 1 CP/dia por 21 dias.">ğŸ’Š etinilestradiol 0,03 mg + desogestrel 0,15 mg</label>
    <label class="pill"><input type="checkbox" value="DIU com Levonorgestrel: Inserir com profissional treinado.">âš™ï¸ DIU levonorgestrel</label>
    <label class="pill"><input type="checkbox" value="ibuprofeno 600 mg">ğŸ’Š ibuprofeno 600 mg</label>
    <label class="pill"><input type="checkbox" value="diclofenaco 50 mg">ğŸ’Š diclofenaco 50 mg</label>
    <label class="pill"><input type="checkbox" value="Ã¡cido mefenÃ¢mico 500 mg">ğŸ’Š Ã¡cido mefenÃ¢mico 500 mg</label>
    <label class="pill"><input type="checkbox" value="Ã¡cido tranexÃ¢mico 500 mg">ğŸ’Š Ã¡cido tranexÃ¢mico 500 mg</label>
    <label class="pill"><input type="checkbox" value="noretisterona 5-10 mg, VO, 4/4h atÃ© cessar sangramento. Depois, de 6/6h por 4 dias; de 8/8h por 3 dias; de 12/12h por 2 dias; em seguida, 1x/dia.">ğŸ’Š noretisterona 5-10 mg</label>
    <label class="pill"><input type="checkbox" value="acetato de medroxiprogesterona 10-20 mg, VO, 4/4h atÃ© cessar sangramento. Depois, de 6/6h por 4 dias; de 8/8h por 3 dias; de 12/12h por 2 dias durante 2 semanas; em seguida, 1x/dia.">ğŸ’Š acetato de medroxiprogesterona 10-20 mg</label>
    <label class="pill"><input type="checkbox" value="Goserrelina 3,6 mg SC mensal (quando indicado).">ğŸ’Š goserrelina 3,6 mg</label>
    <label class="pill"><input type="checkbox" value="Danazol 200 mg VO a cada 12 horas, por 3â€“6 meses (quando indicado).">ğŸ’Š danazol 200 mg</label>
    <!-- ClimatÃ©rio -->
    <label class="pill"><input type="checkbox" value="TRH: estradiol transdÃ©rmico 50 Âµg/24h + progesterona micronizada 200 mg VO Ã  noite por 12â€“14 dias/mÃªs (quando indicado).">ğŸ’Š estradiol 50 Âµg + progesterona 200 mg</label>
    <!-- Ferro -->
    <label class="pill"><input type="checkbox" value="Sulfato ferroso 200 mg">ğŸŸ¤ sulfato ferroso 200 mg</label>
  </div>
  <div class="muted" style="margin-top:6px">Ajuste a posologia conforme protocolo/local e condiÃ§Ãµes clÃ­nicas.</div>
</section>

  <!-- ETAPA 7 -->
  <section class="card step">
    <h2><span class="badge-step">7</span> ObservaÃ§Ãµes clÃ­nicas (opcional) â€¢ âš ï¸ Nesta caixa de texto Ã© o espaÃ§o para remover dados desnecessÃ¡rio do PDF</h2>
    <textarea id="obs" placeholder="Achados objetivos, tempo de sintomas, expectativa do encaminhamento, nÂº da teleconsultoria (se houver)."></textarea>
    <div class="muted">Evite dados sensÃ­veis alÃ©m do nome (se informado).</div>
  </section>

  <!-- ETAPA 8 â€“ SeÃ§Ãµes avanÃ§adas -->
  <section class="card dynamic-section" id="sec-mama">
    <h2><span class="badge-step">8</span> Mama â€¢ Detalhamento</h2>
    <div class="field-group">
      <label>Categoria BI-RADS</label>
      <select id="birads">
        <option value="">Selecione</option>
        <option>BI-RADS 1</option><option>BI-RADS 2</option>
        <option>BI-RADS 3</option><option>BI-RADS 4A</option><option>BI-RADS 4B</option><option>BI-RADS 4C</option><option>BI-RADS 5</option><option>BI-RADS 6</option>
      </select>
      <label class="nested">DiagnÃ³stico histopatolÃ³gico (se houver)</label>
      <input id="mama-histo" placeholder="Ex: Carcinoma ductal invasor">
      <div class="row" style="gap:10px;margin-top:8px;flex-wrap:wrap">
        <div class="switch" data-target="mama-adenopatia" role="switch" aria-checked="false"><div class="track"><div class="thumb"></div></div><span class="label">Adenopatia axilar</span><input type="checkbox" id="mama-adenopatia"></div>
        <div class="switch" data-target="mama-achadofisico" role="switch" aria-checked="false"><div class="track"><div class="thumb"></div></div><span class="label">Achados fÃ­sicos altamente suspeitos</span><input type="checkbox" id="mama-achadofisico"></div>
      </div>
    </div>
  </section>

  <section class="card dynamic-section" id="sec-colo">
    <h2><span class="badge-step">8</span> Colo do Ãštero â€¢ Detalhamento</h2>
    <div class="field-group">
      <label>CitopatolÃ³gico (CP)</label>
      <select id="cp"><option value="">CP: selecione</option><option>Normal/Benigno</option><option>ASC-US</option><option>ASC-H</option><option>LSIL</option><option>HSIL</option><option>AGC</option></select>
      <label class="nested">BiÃ³psia (se realizada)</label>
      <input id="colo-bx" placeholder="Ex: NIC 2/3, carcinoma microinvasor">
      <div class="switch" data-target="colo-lesao-visivel" role="switch" aria-checked="false" style="margin-top:8px"><div class="track"><div class="thumb"></div></div><span class="label">LesÃ£o suspeita ao exame especular</span><input type="checkbox" id="colo-lesao-visivel"></div>
    </div>
  </section>

  <section class="card dynamic-section" id="sec-infertilidade">
    <h2><span class="badge-step">8</span> Planejamento Reprodutivo (Infertilidade) â€¢ Detalhamento</h2>
    <div class="field-group">
      <label>Tempo tentando gestar</label><input id="inf-tempo" placeholder="Ex: 18 meses">
      <label class="nested">Exames relevantes</label><textarea id="inf-exames" class="nested" placeholder="TSH, Prolactina, HSG, Espermograma, etc."></textarea>
      <p class="muted" style="margin:8px 0 6px"><strong>CondiÃ§Ãµes que impedem atendimento em ambulatÃ³rios regulados pelo CRA/RS (protocolo)</strong> â€” ative se presente:</p>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <div class="switch" data-target="inf-ooforect" role="switch" aria-checked="false" title="Ooforectomia bilateral"><div class="track"><div class="thumb"></div></div><span class="label">Ooforectomia bilateral</span><input type="checkbox" id="inf-ooforect"></div>
        <div class="switch" data-target="inf-sempar" role="switch" aria-checked="false" title="Mulher sem parceiro ou casal homoafetivo"><div class="track"><div class="thumb"></div></div><span class="label">Sem parceiro/casal homoafetivo</span><input type="checkbox" id="inf-sempar"></div>
        <div class="switch" data-target="inf-soro" role="switch" aria-checked="false" title="HIV/HBsAg/HCV/HTLV I/II"><div class="track"><div class="thumb"></div></div><span class="label">Soropositividade (HIV/HBsAg/HCV/HTLV)</span><input type="checkbox" id="inf-soro"></div>
        <div class="switch" data-target="inf-cesarea" role="switch" aria-checked="false" title="TrÃªs ou mais cesÃ¡reas prÃ©vias"><div class="track"><div class="thumb"></div></div><span class="label">â‰¥3 cesÃ¡reas prÃ©vias</span><input type="checkbox" id="inf-cesarea"></div>
        <div class="switch" data-target="inf-laquea" role="switch" aria-checked="false" title="Laqueadura/vasectomia sem reversÃ£o"><div class="track"><div class="thumb"></div></div><span class="label">Laqueadura/vasectomia sem reversÃ£o</span><input type="checkbox" id="inf-laquea"></div>
      </div>
      <div class="muted">Se qualquer condiÃ§Ã£o acima estiver presente, o sistema indicarÃ¡ <strong>nÃ£o encaminhar</strong> e orientarÃ¡ seguimento na APS.</div>
    </div>
  </section>

  <section class="card dynamic-section" id="sec-dor-mioma">
    <h2><span class="badge-step">8</span> Endometriose / Miomatose â€¢ Detalhamento</h2>
    <div class="field-group">
      <label>Dor pÃ©lvica crÃ´nica</label><textarea id="dpc" placeholder="DuraÃ§Ã£o (>6m), relaÃ§Ã£o com ciclo, refratariedade â‰¥3m, achados de imagem"></textarea>
      <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:8px">
        <div class="switch" data-target="mioma-sua" role="switch" aria-checked="false"><div class="track"><div class="thumb"></div></div><span class="label">SUA refratÃ¡rio â‰¥3m</span><input type="checkbox" id="mioma-sua"></div>
        <div class="switch" data-target="mioma-compressivo" role="switch" aria-checked="false"><div class="track"><div class="thumb"></div></div><span class="label">Sintomas compressivos</span><input type="checkbox" id="mioma-compressivo"></div>
      </div>
      <textarea id="mioma-tx" class="nested" placeholder="Tratamento jÃ¡ realizado (dose/tempo)" style="margin-top:8px"></textarea>
    </div>
  </section>

  <section class="card dynamic-section" id="sec-climaterio">
    <h2><span class="badge-step">8</span> ClimatÃ©rio â€¢ Detalhamento</h2>
    <div class="field-group"><textarea id="clima" placeholder="Sintomas persistentes, TRH tentada, contraindicaÃ§Ãµes, resposta parcial"></textarea></div>
  </section>

  <section class="card dynamic-section" id="sec-lesoes">
    <h2><span class="badge-step">8</span> LesÃµes Vulvares / Condiloma â€¢ Detalhamento (apoio)</h2>
    <div class="field-group"><textarea id="lesoes" placeholder="LocalizaÃ§Ã£o, tamanho, caracterÃ­sticas, refratariedade, suspeita de malignidade"></textarea></div>
  </section>

  <!-- ETAPA 9 -->
  <section class="card step" id="fim">
    <h2><span class="badge-step">9</span> SaÃ­da â€¢ Texto rÃ¡pido</h2>
    <div class="outbox">
      <textarea id="saida" readonly placeholder="Use â€œGerar rascunhoâ€ ou â€œFORMATO GERCONâ€."></textarea>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="counter muted" id="cont">0 / 2000</div>
        <div class="actions">
          <button id="build" class="btn" title="Gerar rascunho">âš™ï¸ Gerar rascunho</button>
          <button id="copy2" class="btn-sec" title="Copiar texto (inferior)">ğŸ“‹ Copiar</button>
          <button id="clear2" class="btn-orange" title="Limpar e reiniciar (inferior)">Limpar ğŸ§¹ resetar</button>
          <button id="gercon2" class="btn-gercon" title="FORMATO GERCON">
            <img src="https://raw.githubusercontent.com/receitailustrada/rxi-imagens/a043cf565f03f16245b013c07d27b2a15e1af2eb/logo-gercon.svg" alt="GERCON">
            FORMATAR
          </button>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- FABs -->
<div class="fab" aria-hidden="false">
  <button id="btn-legal" class="btn">ğŸ“‘<span id="badge-legal" class="badge-dot" style="display:none">0</span></button>
  <button id="btn-topo" class="navbtn" title="Ir ao topo"><span>â†‘</span></button>
  <button id="btn-fim" class="navbtn" title="Ir ao fim"><span>â†“</span></button>
</div>

<!-- Drawer Legal -->
<aside id="drawer-legal" class="drawer" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3>ğŸ“‘ Base legal, Portarias & Diretrizes</h3>
    <button id="legal-close" class="btn-ghost">âœ–ï¸ Fechar</button>
  </div>
  <div class="chips" id="chipsDocs"></div>
  <div class="row" style="gap:8px;margin-top:10px">
    <div class="switch" id="sw-inc-legal" role="switch" aria-checked="true"><div class="track"><div class="thumb"></div></div><span class="label">Incluir BASE LEGAL no texto</span><input type="checkbox" id="incLegal" checked></div>
    <div class="switch" id="sw-legal-mode" role="switch" aria-checked="true"><div class="track"><div class="thumb"></div></div><span class="label">Modo: Sintetizada</span><input type="checkbox" id="legalSynth" checked></div>
    <button id="legal-apply" class="btn">Aplicar</button>
  </div>
</aside>

<footer>
  <div class="credits">
    <strong>CrÃ©ditos:</strong> Painel de Encaminhamento SERMulher RS â€” 
    <strong>Daniel Fagundes Audino</strong>, MÃ©dico (CRM-RS 48988), ESF X Vila Nova Maria InÃªs Faccin, Cruz Alta/RS. 
    Desenvolvimento integral e independente do cÃ³digo, hospedado em <a href="https://www.receitailustrada.com.br" target="_blank">www.receitailustrada.com.br</a>, 
    com base nos protocolos oficiais (TelessaÃºdeRS, SES/RS, INCA e demais referÃªncias) utilizados como guia tÃ©cnico. 
    Finalidade: apoiar profissionais de saÃºde na elaboraÃ§Ã£o de encaminhamentos claros e qualificados, evitando atrasos no tratamento das pacientes. 
    ResponsÃ¡vel pela implantaÃ§Ã£o local: Secretaria de Planejamento de Cruz Alta â€” 
    <strong>DMCBW</strong>, Coordenadora do Programa SERMulher no municÃ­pio. 
    O sistema gera textos formatados automaticamente para o padrÃ£o <strong>GERCON</strong>, facilitando a inserÃ§Ã£o na plataforma oficial de encaminhamentos.
  </div>
</footer>


<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  if (window.pdfjsLib) {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  }
</script>

<!-- Tesseract.js (OCR local) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
(function(){
  const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));

  /* Toast */
  const toast=$('#toast') || (function(){const t=document.createElement('div');t.id='toast';t.className='toast';t.setAttribute('role','status');t.setAttribute('aria-live','polite');t.setAttribute('aria-atomic','true');t.setAttribute('aria-hidden','true');document.body.appendChild(t);return t;})();
  const showToast=m=>{ toast.textContent=m; toast.setAttribute('aria-hidden','false'); toast.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>{toast.classList.remove('show'); toast.setAttribute('aria-hidden','true');},1600); };

  /* Datas iniciais */
  const today=new Date(); const pad=n=>String(n).padStart(2,'0');
  $('#data').value=`${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;

  /* Util: ISO -> dd/mm/aaaa */
  const parseISO=s=>{ if(!s) return null; const [Y,M,D]=s.split('-').map(v=>parseInt(v,10)); if(!Y||!M||!D) return null; return new Date(Y,M-1,D); };
  const fmtBR=s=>{ const d=parseISO(s); if(!d) return s||''; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; };

  /* Switch helper */
  const bindSwitch = sw => {
    const input=sw.querySelector('input[type="checkbox"]');
    const toggle=()=>{ sw.classList.toggle('on'); const on=sw.classList.contains('on'); sw.setAttribute('aria-checked',on?'true':'false'); input.checked=on;
      if(sw.id==='sw-autoroute-dup'){ recomputeRoute(); }
      if(sw.id==='switch-upper') atualizarRascunho();
      if(sw.id==='sw-age-note') atualizarRascunho();
      if(sw.id==='sw-inc-exam') atualizarRascunho();
    };
    sw.addEventListener('click',e=>{ if(e.target===input) return; toggle(); });
    if(input.checked){ sw.classList.add('on'); sw.setAttribute('aria-checked','true'); }
  };
  $$('.switch').forEach(bindSwitch);
  $('#upper').addEventListener('change',()=>{ const sw=$('#switch-upper'); if($('#upper').checked){sw.classList.add('on');sw.setAttribute('aria-checked','true');} else {sw.classList.remove('on');sw.setAttribute('aria-checked','false');} atualizarRascunho(); });

  /* PÃ­lulas genÃ©ricas */
  function initPills(containerSel){
    $$(containerSel+' .pill').forEach(p=>{
      p.addEventListener('click',e=>{
        if(e.target.tagName.toLowerCase()==='input') return;
        p.classList.toggle('active');
        const input=p.querySelector('input'); if(input) input.checked=p.classList.contains('active');
        maybeShowLesoes(); recomputeRoute(); validar(); atualizarRascunho();
      });
    });
  }
  initPills('#sinais'); initPills('#exames'); initPills('#meds'); initPills('#meds-dose');

  /* Chips do exame fÃ­sico â€“ alterna inserir/remover + destaque */
  const chipState = new Map(); // key -> inserted text
  function toggleChip(chip){
    const key = chip.dataset.key || chip.textContent.trim();
    const text = (chip.dataset.text || chip.textContent).trim();
    const ta = $('#exame-txt');
    if(chipState.has(key)){
      // remover
      const toRemove = chipState.get(key);
      const re = new RegExp((toRemove+'\\n?').replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g');
      ta.value = ta.value.replace(re,'').trim();
      chip.dataset.active = 'false';
      chipState.delete(key);
    } else {
      // inserir (no fim, com \n)
      ta.value = (ta.value ? ta.value.trim()+"\n" : "") + text;
      chip.dataset.active = 'true';
      chipState.set(key, text);
      const sw=$('#sw-inc-exam'); if(!$('#incExam').checked){ sw.classList.add('on'); sw.setAttribute('aria-checked','true'); $('#incExam').checked=true; }
    }
    atualizarRascunho();
  }
  $('#exam-normais').addEventListener('click',e=>{ const chip=e.target.closest('.chip'); if(!chip) return; toggleChip(chip); });
  $('#exam-alterados').addEventListener('click',e=>{ const chip=e.target.closest('.chip'); if(!chip) return; toggleChip(chip); });

  $('#exam-fill-normal').addEventListener('click',()=>{
    const bloco = [
      "Geral: bom estado geral, corada, hidratada, anictÃ©rica, afebril.",
      "Sinais vitais estÃ¡veis (PA e FC em valores de referÃªncia).",
      "Mamas: simÃ©tricas, sem retraÃ§Ãµes/pele em casca de laranja; sem nÃ³dulos palpÃ¡veis; sem descarga papilar.",
      "Axilas: sem linfonodomegalias palpÃ¡veis.",
      "Abdome: plano, flÃ¡cido, indolor Ã  palpaÃ§Ã£o, sem massas palpÃ¡veis.",
      "Especular: colo rosado, sem lesÃµes visÃ­veis ou sangramento.",
      "Toque bimanual: Ãºtero em volume habitual, mÃ³vel, indolor; anexos livres, sem massas."
    ].join("\n");
    $('#exame-txt').value = bloco;
    const sw=$('#sw-inc-exam'); if(!$('#incExam').checked){ sw.classList.add('on'); sw.setAttribute('aria-checked','true'); $('#incExam').checked=true; }
    atualizarRascunho(); flashDone('#exam-fill-normal');
  });
  $('#exam-clear').addEventListener('click',()=>{ $('#exame-txt').value=''; chipState.clear(); $$('#sec-exame .chip').forEach(c=>c.dataset.active='false'); atualizarRascunho(); });

  /* Filtro de grupos */
  document.querySelector('.group-bar').addEventListener('click',(e)=>{
    const btn=e.target.closest('.gbtn'); if(!btn) return;
    $$('.gbtn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    const g=btn.getAttribute('data-group');
    $$('#sinais .pill').forEach(p=>{ p.style.display=(g==='all'||p.getAttribute('data-group')===g)?'inline-flex':'none'; });
  });

  /* SeÃ§Ãµes dinÃ¢micas (por eixo) */
  const mapaSecoes={
    'Mama':'#sec-mama',
    'Colo do Ãštero':'#sec-colo',
    'Planejamento Reprodutivo (Infertilidade)':'#sec-infertilidade',
    'Endometriose / Miomatose':'#sec-dor-mioma',
    'ClimatÃ©rio':'#sec-climaterio'
  };
  function atualizaSecoes(){
    const linha=$('#linha').value;
    $$('.dynamic-section').forEach(s=>s.style.display='none');
    if(mapaSecoes[linha]){ const el=document.querySelector(mapaSecoes[linha]); if(el) el.style.display='block'; }
    maybeShowLesoes();
  }
  function maybeShowLesoes(){
    const hasLesao = $$('#sinais .pill.active input[value="LesÃ£o/ulceraÃ§Ã£o vulvar"]').length>0 || $$('#sinais .pill.active input[value="Prurido vulvar persistente"]').length>0;
    const sec = $('#sec-lesoes'); if(sec) sec.style.display = hasLesao ? 'block' : 'none';
  }
  $('#linha').addEventListener('change',()=>{ atualizaSecoes(); recomputeRoute(); validar(); atualizarRascunho(); }); atualizaSecoes();

  /* Util seleÃ§Ã£o */
  const selecionados = id => $$(`#${id} .pill.active`).map(el=>({val:(el.querySelector('input')?.value||el.textContent).trim(), grp:el.getAttribute('data-group')||'geral', el}));
  const valuesOnly = id => selecionados(id).map(x=>x.val);
  const hasVal = (arr, v)=>arr.includes(v);
  const anyVal = (arr, vs)=>vs.some(v=>arr.includes(v));

  /* ====== Idade ====== */
  function ageOn(ref, dob){
    if(!ref||!dob) return null;
    let a=ref.getFullYear()-dob.getFullYear();
    const m = ref.getMonth()-dob.getMonth();
    if(m<0 || (m===0 && ref.getDate()<dob.getDate())) a--;
    return a;
  }
  function updateAge(){
    const ref=parseISO($('#data').value)||new Date();
    const dob=parseISO($('#dob').value);
    const a=ageOn(ref,dob);
    $('#idade').value = (a==null||isNaN(a)) ? 'â€”' : `${a} anos`;
    validar(); atualizarRascunho();
  }
  $('#data').addEventListener('change',updateAge);
  $('#dob').addEventListener('change',updateAge);

  /* ====== Roteador ====== */
  function roteador(){
    const rs={dest:'SERMulher RS', prioridade:'Rotina ğŸŸ¢', risco:null, motivos:[]};
    const sVals=valuesOnly('sinais'); const exVals=valuesOnly('exames');
    const linha=$('#linha').value;

    // Mama
    if(anyVal(sVals,['Descarga papilar sanguinolenta','Pele em casca de laranja ou retraÃ§Ã£o','InversÃ£o recente do mamilo','Adenopatia axilar'])){
      rs.dest='SERMulher RS'; rs.prioridade='UrgÃªncia ambulatorial ğŸ”´'; rs.motivos.push('Sinais mamÃ¡rios de alerta');
    } else if(hasVal(sVals,'NÃ³dulo mamÃ¡rio palpÃ¡vel')){ rs.dest='SERMulher RS'; rs.prioridade='Preferencial ğŸŸ¡'; rs.motivos.push('NÃ³dulo palpÃ¡vel'); }

    const birads=$('#birads').value;
    if(/BI-RADS 5|BI-RADS 6|BI-RADS 4C/.test(birads)){ rs.dest='SERMulher RS'; rs.prioridade='UrgÃªncia ambulatorial ğŸ”´'; rs.motivos.push(`BI-RADS ${birads}`); }
    else if(/BI-RADS 4A|BI-RADS 4B|BI-RADS 3/.test(birads)){ rs.dest='SERMulher RS'; rs.prioridade='Preferencial ğŸŸ¡'; rs.motivos.push(`BI-RADS ${birads}`); }
    if(hasVal(exVals,'BI-RADS 4 ou 5')){ rs.dest='SERMulher RS'; rs.prioridade='UrgÃªncia ambulatorial ğŸ”´'; rs.motivos.push('Exame BI-RADS 4/5'); }

    // Colo
    const cp=$('#cp').value;
    if(hasVal(sVals,'Citologia alterada (ASC-H/AGC/HSIL)')||cp==='HSIL'||cp==='AGC'||$('#colo-lesao-visivel').checked){
      rs.dest='SERMulher RS'; rs.prioridade='Preferencial ğŸŸ¡'; rs.motivos.push('AlteraÃ§Ãµes citolÃ³gicas/lesÃ£o');
    }
    if(hasVal(sVals,'Sangramento pÃ³s-coital persistente')){ rs.dest='SERMulher RS'; rs.prioridade='Preferencial ğŸŸ¡'; rs.motivos.push('Sangramento pÃ³s-coital'); }

    // Gerais
    if(hasVal(sVals,'Sangramento pÃ³s-menopausa')){ rs.dest='SERMulher RS'; rs.prioridade='Preferencial ğŸŸ¡'; rs.motivos.push('Sangramento pÃ³s-menopausa'); }
    if(anyVal(sVals,['Suspeita de endometriose ou adenomiose','Miomatose com sangramento refratÃ¡rio','Dor pÃ©lvica crÃ´nica'])){ rs.dest='SERMulher RS'; rs.prioridade='Preferencial ğŸŸ¡'; rs.motivos.push('Endometriose/mioma/dor crÃ´nica'); }
    if(hasVal(sVals,'Sintomas de climatÃ©rio persistentes apÃ³s manejo na APS')){ rs.dest='SERMulher RS'; rs.prioridade='Rotina ğŸŸ¢'; rs.motivos.push('ClimatÃ©rio persistente'); }

    // Agudo
    if(hasVal(sVals,'Dor pÃ©lvica aguda')){
      if(anyVal(sVals,['Massa anexial palpÃ¡vel','Aumento do volume abdominal']) || hasVal(exVals,'Î²-hCG sÃ©rico')){
        rs.dest='Hospital'; rs.risco='AMARELO'; rs.prioridade='UrgÃªncia ambulatorial ğŸ”´'; rs.motivos.push('Dor aguda + massa/volume â†’ Hospital');
      } else { rs.dest='UPA 24h'; rs.risco='AMARELO'; rs.prioridade='UrgÃªncia ambulatorial ğŸ”´'; rs.motivos.push('Dor pÃ©lvica aguda â†’ UPA'); }
    }

    if(linha==='Planejamento Reprodutivo (Infertilidade)') rs.motivos.push('Eixo de Planejamento Reprodutivo');

    return rs;
  }

  function recomputeRoute(){
    const rs=roteador();
    $('#route-dest').textContent=rs.dest;
    const elPrio=$('#route-prio'); const elRisk=$('#route-risk');
    if(rs.prioridade){ elPrio.style.display='inline-flex'; elPrio.textContent=rs.prioridade; } else elPrio.style.display='none';
    if(rs.risco){ elRisk.style.display='inline-flex'; elRisk.textContent=`Risco: ${rs.risco}`; } else elRisk.style.display='none';
    $('#route-why').textContent=rs.motivos.length?('Motivo: '+rs.motivos.join(' â€¢ ')):''; 

    if($('#autoroute-dup').checked){ $('#destinoManual').value=rs.dest; $('#prioridade').value=rs.prioridade||$('#prioridade').value; }
  }

  function flashDone(sel){
    const b=$(sel); if(!b) return;
    b.classList.add('btn-done'); setTimeout(()=>b.classList.remove('btn-done'),900);
  }

  // BotÃ£o "Aplicar no texto" (apenas na Etapa 2)
  (function(){
    const btn='#apply-route-dup';
    $(btn).addEventListener('click',()=>{
      const sw=$('#sw-autoroute-dup'); const cb=$('#autoroute-dup');
      sw.classList.add('on'); sw.setAttribute('aria-checked','true'); cb.checked=true;
      recomputeRoute(); showToast('Destino aplicado.'); flashDone(btn);
    });
  })();

  /* ====== Base legal ====== */
  const docs=[['RegulaSUS / TelessaÃºdeRS','Ginecologia adulto','2023','Fluxos/critÃ©rios RS'],
              ['INCA','DetecÃ§Ã£o precoce â€“ cÃ¢ncer de mama','2022','DetecÃ§Ã£o precoce â€¢ mama'],
              ['RegulaSUS / TelessaÃºdeRS','Encaminhamento â€“ Mastologia','2020','Encaminhamento â€¢ Mastologia'],
              ['INCA','Rastreamento â€“ colo do Ãºtero','2019','Rastreamento â€¢ colo'],
              ['RegulaSUS / TelessaÃºdeRS','Encaminhamento â€“ Infertilidade','2019','Encaminhamento â€¢ infertilidade'],
              ['INCA','Diretrizes â€“ rastreamento do colo','2016','Diretrizes â€¢ colo'],
              ['INCA','Diretrizes â€“ detecÃ§Ã£o precoce da mama','2015','Diretrizes â€¢ mama']];
  const selDocs=new Set();
  function renderDocs(){ const wrap=$('#chipsDocs'); wrap.innerHTML=''; docs.forEach(d=>{ const id=`${d[0]} â€¢ ${d[1]} (${d[2]})`; const chip=document.createElement('label'); chip.className='chip'; chip.dataset.active=selDocs.has(id)?'true':'false'; chip.title=d[3]; chip.innerHTML=`<span class="lbl">${id}</span>`; chip.addEventListener('click',()=>{ if(selDocs.has(id)) selDocs.delete(id); else selDocs.add(id); renderDocs(); }); wrap.appendChild(chip); }); }
  renderDocs();
  const drawer=$('#drawer-legal');
  $('#btn-legal').addEventListener('click',()=>{ drawer.classList.add('show'); drawer.setAttribute('aria-hidden','false'); });
  $('#legal-close').addEventListener('click',()=>{ drawer.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); });
  $('#legal-apply').addEventListener('click',()=>{ updateLegalBadge(); drawer.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); atualizarRascunho(); showToast('Base legal aplicada.'); flashDone('#legal-apply'); });
  function updateLegalBadge(){ const n=selDocs.size; const b=$('#badge-legal'); if(n>0){ b.style.display='inline-block'; b.textContent=n; } else { b.style.display='none'; } }
  function buildBaseLegal(){ if(!$('#incLegal').checked) return ''; const a=Array.from(selDocs); if(a.length===0) return ''; if($('#legalSynth').checked){ const out=a.map(t=>{const m=/(.*) â€¢ (.*) \((\d{4})\)/.exec(t); return m?`${m[1]} ${m[3]} â€“ ${m[2]}`:t;}); return 'BASE LEGAL/DIRETRIZES: '+out.join('; ')+'.'; } return 'BASE LEGAL/DIRETRIZES: '+a.join(' | ')+'.'; }

  /* ====== Validator ====== */
  const expectedGroupByLine={'Mama':'mama','Colo do Ãštero':'utero','Planejamento Reprodutivo (Infertilidade)':'geral','Endometriose / Miomatose':'geral','ClimatÃ©rio':'geral'};
  const riscoPermitido={'CAPS':['VERDE','AMARELO'],'UPA 24h':['VERDE','AMARELO','VERMELHO'],'Hospital':['AMARELO','VERMELHO'],'SERMulher RS':null};
  let noReferralMode=false; let hadInconsistency=false;

  function countsByGroup(){
    const sel=selecionados('sinais'); const c={mama:0,utero:0,geral:0};
    sel.forEach(x=>{ if(c[x.grp]!=null) c[x.grp]++; });
    return {c, sel};
  }
  function clearHighlights(){ $$('.pill').forEach(p=>p.classList.remove('err')); }
  function highlightGroup(grp){ $$(`#sinais .pill[data-group="${grp}"]`).forEach(p=>{ if(p.classList.contains('active')) p.classList.add('err'); }); }

  function validar(){
    clearHighlights();
    const erros=[]; const fixes=[];
    const linha=$('#linha').value;
    const auto=$('#autoroute-dup').checked;
    const rs=roteador();
    const destEf = auto ? rs.dest : $('#destinoManual').value;

    // idade
    const refDate=parseISO($('#data').value)||new Date();
    const dob=parseISO($('#dob').value);
    const idade=ageOn(refDate,dob);

    // 1) Linha Ã— sinais
    const {c}=countsByGroup(); const total=c.mama+c.utero+c.geral;
    if(total>0){
      const exp=expectedGroupByLine[linha]||'geral';
      const dom=Object.entries(c).sort((a,b)=>b[1]-a[1])[0][0];
      if(exp!=='geral' && dom!==exp){
        erros.push(`Linha "${linha}" conflita com sinais predominantemente de "${dom==='mama'?'Mama':'Colo do Ãštero'}".`);
        fixes.push(()=>{ const newLine = dom==='mama'?'Mama':'Colo do Ãštero'; $('#linha').value=newLine; atualizaSecoes(); });
        highlightGroup(dom);
      }
    }

    // 2) CAPS invÃ¡lido
    if(destEf==='CAPS'){
      erros.push('Destino "CAPS" incompatÃ­vel com queixas ginecolÃ³gicas.');
      fixes.push(()=>{ $('#destinoManual').value = (rs.dest==='CAPS'?'SERMulher RS':rs.dest); });
    }

    // 3) UPA/Hospital sem sinal agudo
    const sVals=valuesOnly('sinais');
    const temAgudo = sVals.includes('Dor pÃ©lvica aguda');
    if((destEf==='Hospital'||destEf==='UPA 24h') && !temAgudo){
      erros.push(`Destino "${destEf}" marcado sem sinal agudo selecionado.`);
      fixes.push(()=>{ $('#destinoManual').value = rs.dest || 'SERMulher RS'; });
    }

    // 4) Risco por destino
    if((destEf==='Hospital'||destEf==='UPA 24h'||destEf==='CAPS') && rs.risco){
      const permit = riscoPermitido[destEf];
      if(permit && !permit.includes(rs.risco)){
        erros.push(`Risco "${rs.risco}" Ã© incompatÃ­vel com "${destEf}".`);
        fixes.push(()=>{ $('#destinoManual').value = (destEf==='CAPS'?'UPA 24h':'Hospital'); });
      }
    }

    // 5) Infertilidade: bloqueios do protocolo
    let blockInf=false;
    if(linha==='Planejamento Reprodutivo (Infertilidade)'){
      const anyBlock = ['inf-ooforect','inf-sempar','inf-soro','inf-cesarea','inf-laquea'].some(id=>$('#'+id).checked);
      if(anyBlock){ blockInf=true; erros.push('Infertilidade com condiÃ§Ã£o impeditiva (protocolo CRA/RS).'); }
    }

    // 6) Infertilidade + idade â‰¥ 40
    let ageBlock=false;
    if(linha==='Planejamento Reprodutivo (Infertilidade)' && (idade!=null) && idade>=40){
      ageBlock=true;
      erros.push(`Infertilidade com idade ${idade} anos: chance extremamente baixa e risco fetal elevado.`);
      $('#no-ref').style.display='inline-flex';
      fixes.push(()=>{ $('#prioridade').value='Rotina ğŸŸ¢'; });
      const sw=$('#sw-age-note'); if(!$('#ageNote').checked){ sw.classList.add('on'); sw.setAttribute('aria-checked','true'); $('#ageNote').checked=true; }
    } else {
      $('#no-ref').style.display='none';
    }

    renderAlert(erros, fixes, {ageBlock, blockInf});
    toggleActions(erros.length===0, {ageBlock, blockInf});
    hadInconsistency = (erros.length > 0);
    return {ok:erros.length===0, erros, fixes, idade};
  }

  function renderAlert(erros, fixes, meta){
    const al=$('#alert'); const lst=$('#alert-list'); lst.innerHTML='';
    if(erros.length===0){ al.style.display='none'; return; }
    erros.forEach(e=>{ const li=document.createElement('li'); li.textContent=e; lst.appendChild(li); });
    al.style.display='block';
    $('#fix-auto').onclick = ()=>{ fixes.forEach(f=>f()); recomputeRoute(); const v=validar(); if(v.ok){ showToast('CoerÃªncia corrigida.'); } atualizarRascunho(); };
    $('#dismiss').onclick = ()=>{ al.style.display='none'; toggleActions(false,meta); showToast('InconsistÃªncias ignoradas (atenÃ§Ã£o).'); };
    $('#no-ref').onclick = ()=>{
      noReferralMode=true;
      $('#destinoManual').value='SERMulher RS';
      al.style.display='none';
      showToast('Nota de risco inserida e marcado como NÃƒO ENCAMINHAR.'); atualizarRascunho();
      toggleActions(true, meta, {forceNoGercon:true});
    };
  }

  function toggleActions(enable, meta={}, opts={}){
    const btns=['#build','#copy','#copy2'];
    btns.forEach(id=>{ const b=$(id); if(!b) return; if(enable){ b.classList.remove('disabled'); b.disabled=false; } else { b.classList.add('disabled'); b.disabled=true; } });
    const gerconBtns=['#gercon','#gercon2'];
    const blockGercon = (!enable) || noReferralMode || opts.forceNoGercon===true || (meta.ageBlock===true && enable===false) || (meta.blockInf===true && enable===false);
    gerconBtns.forEach(id=>{ const b=$(id); if(!b) return; if(blockGercon){ b.classList.add('disabled'); b.disabled=true; } else { b.classList.remove('disabled'); b.disabled=false; } });
  }

  /* ====== Texto / GERCON ====== */
  function toLatin1Safe(txt){
    const map={'â€œ':'"','â€':'"','â€':'"','Â«':'"','Â»':'"','â€˜':"'",'â€™':"'",'â€š':"'",'Â´':"'",'â€':'-','â€“':'-','â€”':'-','â€¢':'-','Â·':'-','â€¦':'...','â†’':'->','â†”':'<->','Ã—':'x','âˆ’':'-'};
    txt = txt.replace(/[\u2018\u2019\u201A\u00B4]/g,m=>map[m]||"'").replace(/[\u201C\u201D\u201E\u00AB\u00BB]/g,m=>map[m]||'"').replace(/[\u2010\u2011\u2013\u2014\u2022\u00B7\u2026\u2192\u2194\u00D7\u2212]/g,m=>map[m]||'-');
    try{ txt=txt.replace(/\p{Extended_Pictographic}|\p{Emoji_Presentation}/gu,''); }catch(e){ txt=txt.replace(/[\u{1F300}-\u{1FAFF}]/gu,''); }
    let out=''; for(const ch of txt){ const c=ch.codePointAt(0); if(ch==='\n'||ch==='\r'||ch==='\t'||(c>=0x20&&c<=0x7E)||(c>=0xA0&&c<=0xFF)) out+=ch; }
    out=out.replace(/[ \t]+/g,' ').replace(/\n{3,}/g,'\n\n').trim(); if($('#upper').checked) out=out.toUpperCase(); return out;
  }
  function setOutput(txt){ const t=txt.length>2000?txt.slice(0,2000):txt; $('#saida').value=t; const c=$('#cont'); c.textContent=`${t.length} / 2000`; c.className='counter muted'+(t.length>1900?' danger':''); }

  function buildAgeNote(idade){
    if(idade==null) return '';
    if(idade>=40){
      return `Nota de risco por idade: Paciente com ${idade} anos, desejando gestaÃ§Ã£o. Explicado que a fertilidade Ã© muito reduzida nessa faixa etÃ¡ria, com maior risco de alteraÃ§Ãµes cromossÃ´micas (ex.: sÃ­ndrome de Down) e de complicaÃ§Ãµes materno-fetais. Orientada sobre aconselhamento reprodutivo e opÃ§Ãµes na APS.`;
    }
    return '';
  }

  function montarRascunho(){
    const nome=$('#nome').value.trim();
    const dataISO=$('#data').value || '';
    const dataBR=fmtBR(dataISO);
    const linha=$('#linha').value;

    // idade
    const refDate=parseISO($('#data').value)||new Date();
    const dob=parseISO($('#dob').value);
    const idade=ageOn(refDate,dob);
    const idadeStr = (idade==null||isNaN(idade)) ? '' : ` | Idade: ${idade} anos`;

    const auto=$('#autoroute-dup').checked; const rs=roteador();
    const destEf=auto?rs.dest:$('#destinoManual').value;
    const prioridadeEf=auto?(rs.prioridade||$('#prioridade').value):$('#prioridade').value;
    const riscoEf=(destEf==='UPA 24h'||destEf==='Hospital'||destEf==='CAPS')?(rs.risco||null):null;

    const s=valuesOnly('sinais'); const e=valuesOnly('exames');
    const m1=valuesOnly('meds'); const m2=valuesOnly('meds-dose'); const obs=$('#obs').value.trim();
    const medsOut=[...m1, ...m2];

    const linhas=[];
    linhas.push(`Encaminhamento â€“ SERMulher RS`);
    linhas.push(`Data: ${dataBR}${nome?` | Paciente: ${nome}`:''}${idadeStr}`);
    linhas.push(`Linha de cuidado (eixo oficial): ${linha}`);

    if(noReferralMode){
      linhas.push(`DESTINO DEFINIDO: NÃƒO ENCAMINHAR â€“ orientaÃ§Ã£o e aconselhamento na APS (registro em prontuÃ¡rio).`);
    } else {
      linhas.push(`DESTINO DEFINIDO: ${destEf}${riscoEf?` â€¢ ClassificaÃ§Ã£o de risco: ${riscoEf}`:''} â€¢ Prioridade: ${prioridadeEf}`);
    }

    if(s.length) linhas.push(`Sinais/sintomas: ${s.join('; ')}.`);
    if(e.length) linhas.push(`Exames (realizados/solicitados): ${e.join('; ')}.`);

    // Exame fÃ­sico (opcional)
    if($('#incExam').checked){
      const examTxt = ($('#exame-txt').value||'').trim();
      if(examTxt){ linhas.push(`Exame fÃ­sico:\n${examTxt}`); }
    }

    if(medsOut.length) linhas.push(`Medicamentos/condutas na APS: ${medsOut.join('; ')}.`);

    if(linha==='Mama'){ const b=$('#birads').value, h=$('#mama-histo').value.trim(), ad=$('#mama-adenopatia').checked, af=$('#mama-achadofisico').checked; const det=[]; if(b) det.push(`BI-RADS: ${b}`); if(h) det.push(`Histopatologia: ${h}`); if(ad) det.push('Adenopatia axilar'); if(af) det.push('Achados fÃ­sicos altamente suspeitos'); if(det.length) linhas.push(det.join(' â€¢ ')+'.'); }
    if(linha==='Colo do Ãštero'){ const cp=$('#cp').value, bx=$('#colo-bx').value.trim(), ls=$('#colo-lesao-visivel').checked; const det=[]; if(cp) det.push(`CP: ${cp}`); if(bx) det.push(`BiÃ³psia: ${bx}`); if(ls) det.push('LesÃ£o visÃ­vel ao exame especular'); if(det.length) linhas.push(det.join(' â€¢ ')+'.'); }
    if(linha==='Planejamento Reprodutivo (Infertilidade)'){ const t=$('#inf-tempo').value.trim(), ex=$('#inf-exames').value.trim(); if(t) linhas.push(`Tempo tentando gestar: ${t}.`); if(ex) linhas.push(`Exames relevantes: ${ex}.`); }

    if(linha==='Endometriose / Miomatose'){ const dpc=$('#dpc').value.trim(), sua=$('#mioma-sua').checked, comp=$('#mioma-compressivo').checked, tx=$('#mioma-tx').value.trim(); if(dpc) linhas.push(`Dor pÃ©lvica crÃ´nica: ${dpc}.`); const arr=[]; if(sua) arr.push('SUA refratÃ¡rio â‰¥3m'); if(comp) arr.push('Sintomas compressivos'); if(arr.length) linhas.push(`Miomatose: ${arr.join(' â€¢ ')}.`); if(tx) linhas.push(`Tratamento jÃ¡ realizado: ${tx}.`); }
    if(linha==='ClimatÃ©rio'){ const c=$('#clima').value.trim(); if(c) linhas.push(`ClimatÃ©rio â€“ detalhes: ${c}.`); }

    const hasLesao = $('#lesoes').value.trim();
    if(hasLesao) linhas.push(`LesÃµes vulvares/condiloma â€“ detalhes: ${$('#lesoes').value.trim()}.`);

    if($('#ageNote').checked || noReferralMode){
      const nota = buildAgeNote(idade);
      if(nota) linhas.push(nota);
    }

    if(hadInconsistency || noReferralMode){
      linhas.push(`âš¡ Â© 2025 RXI emitiu alerta de "NÃƒO ENCAMINHAR" (INCONSISTÃŠNCIAS).`);
    }

    if(obs) linhas.push(`ObservaÃ§Ãµes: ${obs}`);

    const legal=buildBaseLegal(); if(legal) linhas.push(legal);

      if(noReferralMode){ // Se o modo "nÃ£o encaminhar" estÃ¡ ativo (por clique do usuÃ¡rio)
      linhas.push(`Sem encaminhamento no momento. Manter aconselhamento e seguimento na APS conforme protocolos.`);
    } else if (hadInconsistency) { // Se hÃ¡ inconsistÃªncias detectadas que geram o alerta de "NÃƒO ENCAMINHAR"
      // NÃ£o adicionamos a frase "Encaminho", pois o alerta jÃ¡ disse para nÃ£o encaminhar
      // Isso resolve a contradiÃ§Ã£o
    } else { // Caso contrÃ¡rio (sem modo "nÃ£o encaminhar" e sem inconsistÃªncias pendentes)
      linhas.push(`Encaminho conforme protocolo e fluxo vigente para avaliaÃ§Ã£o especializada.`);
    }

    // SELO (sempre Ãºltimo)
    linhas.push(`SELO RXI â€¢ QUALIDADE DO ENCAMINHAMENTO`);

    return linhas.join('\n');

    return linhas.join('\n');
  }

  function atualizarRascunho(){ setOutput(montarRascunho()); }

  // Gate com validaÃ§Ã£o
  function gate(){ const v=validar(); return v.ok; }
  $('#build').addEventListener('click',()=>{ if(!gate()) return showToast('HÃ¡ inconsistÃªncias. Corrija ou use as aÃ§Ãµes sugeridas.'); atualizarRascunho(); showToast('Rascunho atualizado.'); flashDone('#build'); });

  function formatarGercon(){
    if(noReferralMode) { showToast('Sem encaminhamento: GERCON desabilitado.'); return; }
    if(!gate()) return showToast('HÃ¡ inconsistÃªncias. Corrija primeiro.');
    const draft=montarRascunho(); let gerconTxt=toLatin1Safe(draft); if(gerconTxt.length>1900) gerconTxt=gerconTxt.slice(0,1900);
    setOutput(gerconTxt); showToast('Texto formatado para GERCON.'); flashDone('#gercon'); flashDone('#gercon2');
  }
  $('#gercon').addEventListener('click',formatarGercon);
  $('#gercon2').addEventListener('click',formatarGercon);

  async function copiarSaida(btnSel){
    if(!gate()) return showToast('HÃ¡ inconsistÃªncias. Corrija primeiro.');
    const ta=$('#saida'); ta.focus(); ta.select();
    try{ await navigator.clipboard.writeText(ta.value); showToast('Texto copiado!'); flashDone(btnSel); }
    catch{
      try{ document.execCommand('copy'); showToast('Texto copiado!'); flashDone(btnSel); }
      catch(e){ showToast('NÃ£o foi possÃ­vel copiar automaticamente.'); }
    }
  }
  $('#copy').addEventListener('click',()=>copiarSaida('#copy'));
  $('#copy2').addEventListener('click',()=>copiarSaida('#copy2'));

  function doReset(){
    ['sinais','exames','meds','meds-dose'].forEach(id=>{ $$('#'+id+' .pill').forEach(p=>p.classList.remove('active')); $$('#'+id+' input').forEach(i=>i.checked=false); });
    ['nome','obs','mama-histo','colo-bx','inf-tempo','inf-exames','dpc','mioma-tx','clima','lesoes','dob','exame-txt', 'pdfContentDisplay'].forEach(id=>{ const el=$('#'+id); if(el) el.value=''; });
    ['mama-adenopatia','mama-achadofisico','colo-lesao-visivel','mioma-sua','mioma-compressivo','upper','ageNote','incExam','inf-ooforect','inf-sempar','inf-soro','inf-cesarea','inf-laquea'].forEach(id=>{ const el=$('#'+id); if(el){ el.checked=false; const sw=el.closest('.switch'); if(sw){ sw.classList.remove('on'); sw.setAttribute('aria-checked','false'); } } });
    ['birads','cp'].forEach(id=>{ const el=$('#'+id); if(el) el.value=''; });
    // autoroute permanece ativo por padrÃ£o
    const swAuto=$('#sw-autoroute-dup'); const cbAuto=$('#autoroute-dup'); swAuto.classList.add('on'); swAuto.setAttribute('aria-checked','true'); cbAuto.checked=true;

    noReferralMode=false; hadInconsistency=false; chipState.clear(); $$('#sec-exame .chip').forEach(c=>c.dataset.active='false');
    $('#idade').value='â€”';
    $('#addPdfContentToOutput').disabled = true;
    setOutput(''); clearHighlights(); $('#alert').style.display='none'; toggleActions(true); recomputeRoute(); showToast('Campos resetados.');
  }
  $('#clear').addEventListener('click',()=>{ doReset(); flashDone('#clear'); });
  $('#clear2').addEventListener('click',()=>{ doReset(); flashDone('#clear2'); });

  // NavegaÃ§Ã£o
  $('#btn-topo').addEventListener('click',()=>{ document.querySelector('#topo')?.scrollIntoView({behavior:'smooth'}); });
  $('#btn-fim').addEventListener('click',()=>{ document.querySelector('#fim')?.scrollIntoView({behavior:'smooth'}); });

  // Inputs que influenciam validaÃ§Ã£o/saÃ­da
  ['destinoManual','prioridade','birads','cp','colo-bx','mama-histo','inf-tempo','inf-exames','dpc','mioma-tx','clima','lesoes','colo-lesao-visivel','mama-adenopatia','mama-achadofisico','mioma-sua','mioma-compressivo','dob','data','exame-txt','inf-ooforect','inf-sempar','inf-soro','inf-cesarea','inf-laquea','autoroute-dup']
    .forEach(id=>{ const el=$('#'+id); if(el){ const ev=(el.type==='checkbox'?'change':'input'); el.addEventListener(ev,()=>{ recomputeRoute(); validar(); atualizarRascunho(); }); } });

  // ====== PDF/Imagem: leitura e marcaÃ§Ã£o ======
  const pdfFile = $('#pdfFile'),
        pdfRead = $('#pdfRead'),
        pdfStatus = $('#pdfStatus'),
        pdfBadge = $('#pdfBadge'),
        pdfPagesSpan = $('#pdfPages'),
        pdfContentDisplay = $('#pdfContentDisplay'),
        addPdfContentToOutputBtn = $('#addPdfContentToOutput');
  let lastText = '';

  pdfFile.addEventListener('change', ()=>{
    const f = pdfFile.files?.[0];
    if(!f){
      pdfRead.disabled = true;
      pdfStatus.textContent = 'Selecione um arquivo para habilitar a leitura.';
      pdfContentDisplay.value = '';
      addPdfContentToOutputBtn.disabled = true;
      return;
    }
    pdfRead.disabled = false;
    pdfRead.textContent = 'ğŸ“„ Ler PDF/Imagem e marcar';
    pdfStatus.textContent = `Arquivo selecionado: ${f.name} (${Math.round(f.size/1024)} KB).`;
    pdfBadge.style.display='none'; pdfPagesSpan.textContent='0';
    pdfContentDisplay.value = '';
    addPdfContentToOutputBtn.disabled = true;
  });

  addPdfContentToOutputBtn.addEventListener('click', () => {
    const textToAdd = pdfContentDisplay.value.trim();
    const obsTextArea = $('#obs');

    if (textToAdd) {
      if (obsTextArea.value.trim()) {
        obsTextArea.value += "\n\n--- ConteÃºdo do PDF ---\n" + textToAdd;
      } else {
        obsTextArea.value = "--- ConteÃºdo do PDF ---\n" + textToAdd;
      }
      atualizarRascunho();
      showToast('Texto do PDF adicionado Ã s observaÃ§Ãµes!');
      flashDone('#addPdfContentToOutput');
    } else {
      showToast('NÃ£o hÃ¡ texto do PDF para adicionar.');
    }
  });

  function markPillByText(txt, label){
    const p = $$('#exames .pill').find(el => (el.querySelector('input')?.value||'').trim()===label);
    if(p && !p.classList.contains('active')){ p.classList.add('active'); const i=p.querySelector('input'); if(i) i.checked=true; }
  }
  function setBiradsFromText(txt){
    const m = txt.match(/BI[\s-]?RADS[^0-9]*(\d)([A-C])?/i) || txt.match(/Categoria\s*BI[\s-]?RADS[^0-9]*(\d)/i) || txt.match(/Categoria\s*(\d)\b/i);
    if(m){
      const num=m[1], sub=(m[2]||'').toUpperCase();
      const opt=(num==='4'&&sub)?`BI-RADS 4${sub}`:`BI-RADS ${num}`;
      const sel=$('#birads');
      if([...sel.options].some(o=>o.value===opt)) sel.value=opt; else sel.value=`BI-RADS ${num}`;
    }
  }
  function parseExamText(txt){
    if(!txt) return;
    if(/mamograf/i.test(txt)) markPillByText(txt,'Mamografia');
    if(/ultra[\s-]?sonografia.*mam/gi.test(txt) || /US.*mam/gi.test(txt)) markPillByText(txt,'Ultrassonografia mamÃ¡ria');
    if(/resson[aÃ¢]ncia.*mama/i.test(txt)) markPillByText(txt,'RessonÃ¢ncia de mama');
    if(/citopatol|papanicolaou|colo.*citologia/i.test(txt)) markPillByText(txt,'CitopatolÃ³gico cervical');
    if(/colposcop/i.test(txt)) markPillByText(txt,'Colposcopia');
    if(/bi[oÃ³]psia.*colo/i.test(txt)) markPillByText(txt,'BiÃ³psia de colo uterino');
    if(/transvaginal|p[Ã©e]lvic[ao]/i.test(txt)) markPillByText(txt,'US transvaginal ou pÃ©lvica');
    if(/prolactina|TSH/i.test(txt)) markPillByText(txt,'Prolactina e TSH');
    if(/\bCA[-\s]?125\b/i.test(txt)) markPillByText(txt,'CA-125');
    if(/hemograma|ferritina/i.test(txt)) markPillByText(txt,'Hemograma e ferritina');
    if(/hcg\b|Î²[-\s]?hcg/i.test(txt)) markPillByText(txt,'Î²-hCG sÃ©rico');

    setBiradsFromText(txt);
    const bir=$('#birads').value;
    if(/BI-RADS 4|BI-RADS 5/.test(bir)) markPillByText(txt,'BI-RADS 4 ou 5');

    atualizaSecoes(); recomputeRoute(); validar(); atualizarRascunho();
  }

  async function ocrCanvas(canvas){
    if(!window.Tesseract) throw new Error('OCR indisponÃ­vel');
    try{
      const { data:{ text } } = await Tesseract.recognize(canvas, 'por');
      return text||'';
    }catch{
      const { data:{ text } } = await Tesseract.recognize(canvas, 'eng');
      return text||'';
    }
  }

  async function extractTextFromPDF(arrayBuffer, onProgress){
    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
    let full = ''; const pages = Math.min(pdf.numPages, 8);
    for(let p=1;p<=pages;p++){
      onProgress && onProgress(p, pages);
      const page = await pdf.getPage(p);
      let pageText = '';
      try{
        const tc = await page.getTextContent();
        if(tc?.items?.length) pageText = tc.items.map(i=>i.str).join(' ');
      }catch{}
      if(!pageText){
        const viewport = page.getViewport({scale:1.5});
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({canvasContext:ctx, viewport}).promise;
        pageText = await ocrCanvas(canvas);
      }
      full += (pageText||'') + '\n';
    }
    return { text: full, pages };
  }

  pdfRead.addEventListener('click', async ()=>{
    const f = pdfFile.files?.[0];
    if(!f){ showToast('Selecione um arquivo.'); return; }

    pdfRead.disabled = true;
    pdfRead.textContent = 'Lendoâ€¦';
    pdfBadge.style.display='none'; pdfPagesSpan.textContent='0';
    pdfStatus.textContent = 'Iniciando leituraâ€¦';
    pdfContentDisplay.value = '';
    addPdfContentToOutputBtn.disabled = true;

    try{
      const isLikelyPDF = /\.pdf$/i.test(f.name) || f.type==='application/pdf' || f.type==='application/octet-stream';
      if(f.type.startsWith('image/')){
        // OCR direto em imagem
        pdfStatus.textContent = 'Imagem enviada â€” realizando OCRâ€¦';
        const img = document.createElement('img');
        img.onload = async ()=>{
          const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
          canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img,0,0);
          const text = await ocrCanvas(canvas);
          lastText = text;
          pdfContentDisplay.value = lastText;
          if (lastText.trim()) addPdfContentToOutputBtn.disabled = false;
          pdfStatus.textContent = 'Imagem lida (OCR).';
          pdfRead.textContent='Lido âœ“'; pdfRead.classList.add('btn-done');
          pdfBadge.style.display='inline-flex'; pdfPagesSpan.textContent='1';
          parseExamText(text); setTimeout(()=>pdfRead.classList.remove('btn-done'),900);
          pdfRead.disabled=false;
        };
        img.onerror = ()=>{ pdfStatus.textContent='Falha ao carregar a imagem.'; pdfRead.disabled=false; };
        img.src = URL.createObjectURL(f);
        return;
      }

      if(isLikelyPDF){
        const buf = await f.arrayBuffer();
        const {text: t, pages} = await extractTextFromPDF(buf, (p,tot)=>{
          pdfStatus.textContent = `Lendo PDFâ€¦ pÃ¡gina ${p}/${tot}`;
        });
        lastText = t||'';
        pdfContentDisplay.value = lastText;
        if (lastText.trim()) addPdfContentToOutputBtn.disabled = false;
        pdfStatus.textContent = (t && t.trim()) ? 'PDF lido com sucesso.' : 'PDF lido, porÃ©m com pouco texto â€” possivelmente escaneado.';
        pdfRead.textContent='Lido âœ“'; pdfRead.classList.add('btn-done');
        pdfBadge.style.display='inline-flex'; pdfPagesSpan.textContent=String(pages);
        parseExamText(lastText); setTimeout(()=>pdfRead.classList.remove('btn-done'),900);
        pdfRead.disabled=false;
        return;
      }

      // fallback: tentar como imagem via OCR
      pdfStatus.textContent = 'Formato nÃ£o reconhecido â€” tentando OCR como imagemâ€¦';
      const buf = await f.arrayBuffer();
      const blobURL = URL.createObjectURL(new Blob([buf]));
      const img = document.createElement('img');
      img.onload = async ()=>{
        const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
        canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img,0,0);
        const text = await ocrCanvas(canvas);
        lastText = text || '';
        pdfContentDisplay.value = lastText;
        if (lastText.trim()) addPdfContentToOutputBtn.disabled = false;
        pdfStatus.textContent = lastText.trim() ? 'OCR concluÃ­do (fallback como imagem).' : 'OCR concluÃ­do, porÃ©m sem texto legÃ­vel.';
        pdfRead.textContent='Lido âœ“'; pdfRead.classList.add('btn-done');
        pdfBadge.style.display='inline-flex'; pdfPagesSpan.textContent='1';
        parseExamText(lastText);
        setTimeout(()=>pdfRead.classList.remove('btn-done'),900);
        pdfRead.disabled=false;
        URL.revokeObjectURL(blobURL);
      };
      img.onerror = ()=>{ pdfStatus.textContent='NÃ£o foi possÃ­vel ler este arquivo.'; pdfRead.disabled=false; URL.revokeObjectURL(blobURL); };
      img.src = blobURL;

    }catch(err){
      console.error(err);
      pdfStatus.textContent = 'Erro ao ler arquivo. Tente outro PDF/Imagem.';
      pdfRead.disabled = false;
      pdfRead.textContent = 'ğŸ“„ Ler PDF/Imagem e marcar';
    }
  });

})();
</script>
<script>
// ==== GUIA RXI ====
const etapas = [
  {
    titulo: "ğŸ“± Bem-vindo ao Painel RXI â€¢ SERMulher RS",
    texto: "Desenvolvido para apoiar a APS e a rede de atenÃ§Ã£o, este sistema padroniza encaminhamentos conforme os protocolos do projeto. Nosso foco: agilizar fluxos, reduzir erros e <strong>qualificar o cuidado Ã s mulheres.</strong> âœ¨"
  },
  {
    titulo: "ğŸŸ£ Identidade e PadrÃ£o (1/5)",
    texto: "Alinhado ao <strong>Manual de Identidade Visual do SERMulher RS</strong>. A saÃ­da Ã© otimizada para o GERCON (limite de 2000 caracteres) e formatada para ser colada <strong>diretamente no prontuÃ¡rio</strong> da paciente e no GERCON. ğŸ“"
  },
  {
    titulo: "ğŸ©º Linhas de Cuidado (2/5)",
    texto: "Cobrimos os 5 eixos de atendimento: <strong>Colo do Ãºtero â€¢ Mama â€¢ Infertilidade/Planejamento Reprodutivo â€¢ Endometriose/Miomatose â€¢ ClimatÃ©rio.</strong> Cada uma traz o conteÃºdo essencial e condutas baseadas em <strong>diretrizes oficiais</strong> (INCA/MS/SES-RS). âœ…"
  },
  {
    titulo: "ğŸ“± Funcionalidades (3/5)",
    texto: "VocÃª decide! O sistema apenas <strong>sinaliza inconsistÃªncias</strong> para garantir que sua escolha seja a mais assertiva. ğŸ¯"
  },
  {
    titulo: "ğŸš€ Fortalecendo a Rede (4/5)",
    texto: "Use o Painel RXI como sua base para <strong>encaminhamentos padronizados</strong>, relatÃ³rios clÃ­nicos e para criar novos conteÃºdos, <strong>fortalecendo a Rede SERMulher RS</strong> em cada aÃ§Ã£o. ğŸ’š"
  },
  {
    titulo: "âœ’ï¸ CrÃ©ditos (5/5)",
    texto: "CriaÃ§Ã£o integral do Painel: <strong>Daniel Fagundes Audino</strong> â€¢ MÃ©dico da ESF X Vila Nova Maria InÃªs Faccin - Cruz Alta."
  }
];
let etapaAtual = 0;
function atualizarGuia() {
  document.getElementById("guia-titulo").innerHTML = etapas[etapaAtual].titulo;
  document.getElementById("guia-texto").innerHTML = etapas[etapaAtual].texto;
  document.querySelector(".btn-prev").disabled = etapaAtual === 0;
  document.querySelector(".btn-next").style.display = etapaAtual === etapas.length-1 ? "none":"inline-block";
}
function guiaProximo() { if(etapaAtual < etapas.length-1){ etapaAtual++; atualizarGuia(); } }
function guiaAnterior() { if(etapaAtual > 0){ etapaAtual--; atualizarGuia(); } }
function fecharGuia() { document.getElementById("guia-rxi").style.display="none"; }
atualizarGuia();

// ==== DICIONÃRIO DE MENSAGENS EXPANDIDO ====
const mensagens = {
  destino:{curto:{texto:"Destino aplicado.",tipo:"success"},medio:{texto:"âœ… Destino definido.",tipo:"success"},completo:{texto:"âœ… Destino definido com sucesso.",tipo:"success"}},
  baseLegal:{curto:{texto:"Base aplicada.",tipo:"success"},medio:{texto:"ğŸ“š Base legal inserida.",tipo:"success"},completo:{texto:"ğŸ“š Base legal adicionada ao texto final.",tipo:"success"}},
  rascunho:{curto:{texto:"Rascunho gerado.",tipo:"success"},medio:{texto:"ğŸ“ Rascunho atualizado.",tipo:"success"},completo:{texto:"ğŸ“ Rascunho atualizado com sucesso.",tipo:"success"}},
  gercon:{curto:{texto:"Texto pronto.",tipo:"success"},medio:{texto:"ğŸ—‚ï¸ Texto GERCON gerado.",tipo:"success"},completo:{texto:"ğŸ—‚ï¸ Texto formatado conforme padrÃ£o GERCON.",tipo:"success"}},
  copia:{curto:{texto:"Texto copiado.",tipo:"success"},medio:{texto:"ğŸ“‹ Copiado.",tipo:"success"},completo:{texto:"ğŸ“‹ ConteÃºdo copiado para a Ã¡rea de transferÃªncia.",tipo:"success"}},
  copiaErro:{curto:{texto:"CÃ³pia falhou.",tipo:"error"},medio:{texto:"âš ï¸ NÃ£o copiado.",tipo:"error"},completo:{texto:"âš ï¸ NÃ£o foi possÃ­vel copiar automaticamente.",tipo:"error"}},
  reset:{curto:{texto:"Reset feito.",tipo:"info"},medio:{texto:"ğŸ”„ Campos resetados.",tipo:"info"},completo:{texto:"ğŸ”„ Todos os campos foram limpos e reiniciados.",tipo:"info"}},
  inconsistencia:{curto:{texto:"InconsistÃªncia achada.",tipo:"warning"},medio:{texto:"âš ï¸ InconsistÃªncias detectadas.",tipo:"warning"},completo:{texto:"âš ï¸ Foram identificadas inconsistÃªncias â€” revise ou use as aÃ§Ãµes sugeridas.",tipo:"warning"}},
  pendencia:{curto:{texto:"Corrigir pendÃªncias.",tipo:"warning"},medio:{texto:"ğŸš« PendÃªncias ativas.",tipo:"warning"},completo:{texto:"ğŸš« Corrija as pendÃªncias antes de prosseguir.",tipo:"warning"}},
  gerconOff:{curto:{texto:"GERCON off.",tipo:"error"},medio:{texto:"â›” GERCON desabilitado.",tipo:"error"},completo:{texto:"â›” Sem encaminhamento disponÃ­vel: GERCON desabilitado.",tipo:"error"}},
  arquivoVazio:{curto:{texto:"Sem arquivo.",tipo:"info"},medio:{texto:"ğŸ“‚ Nenhum arquivo.",tipo:"info"},completo:{texto:"ğŸ“‚ Nenhum arquivo selecionado para leitura.",tipo:"info"}},
  leitura:{curto:{texto:"Lendo...",tipo:"info"},medio:{texto:"â³ Leitura em andamento.",tipo:"info"},completo:{texto:"â³ Arquivo em leitura, aguarde o processamento.",tipo:"info"}},
  ocrIniciado:{curto:{texto:"OCR iniciado.",tipo:"info"},medio:{texto:"ğŸ–¼ï¸ OCR em andamento.",tipo:"info"},completo:{texto:"ğŸ–¼ï¸ Imagem enviada â€” realizando OCR.",tipo:"info"}},
  ocrOk:{curto:{texto:"OCR pronto.",tipo:"success"},medio:{texto:"âœ… OCR concluÃ­do.",tipo:"success"},completo:{texto:"âœ… Imagem lida com sucesso via OCR.",tipo:"success"}},
  ocrErro:{curto:{texto:"Falha na imagem.",tipo:"error"},medio:{texto:"âŒ Erro na imagem.",tipo:"error"},completo:{texto:"âŒ Falha ao carregar a imagem selecionada.",tipo:"error"}},
  pdfOk:{curto:{texto:"PDF lido.",tipo:"success"},medio:{texto:"ğŸ“– PDF processado.",tipo:"success"},completo:{texto:"ğŸ“– PDF lido com sucesso.",tipo:"success"}},
  pdfPouco:{curto:{texto:"PDF vazio.",tipo:"warning"},medio:{texto:"âš ï¸ Pouco texto.",tipo:"warning"},completo:{texto:"âš ï¸ PDF lido, mas contÃ©m pouco texto (provavelmente escaneado).",tipo:"warning"}},
  pdfOcrFallback:{curto:{texto:"OCR fallback.",tipo:"info"},medio:{texto:"ğŸ”„ Tentando OCR.",tipo:"info"},completo:{texto:"ğŸ”„ Formato nÃ£o reconhecido â€” tentando OCR como imagem.",tipo:"info"}},
  ocrSemTexto:{curto:{texto:"OCR sem texto.",tipo:"warning"},medio:{texto:"âš ï¸ OCR sem resultado.",tipo:"warning"},completo:{texto:"âš ï¸ OCR concluÃ­do, mas sem texto legÃ­vel.",tipo:"warning"}},
  erroArquivo:{curto:{texto:"Erro no arquivo.",tipo:"error"},medio:{texto:"âŒ Arquivo invÃ¡lido.",tipo:"error"},completo:{texto:"âŒ NÃ£o foi possÃ­vel processar o arquivo selecionado.",tipo:"error"}},
  erroLeitura:{curto:{texto:"Erro na leitura.",tipo:"error"},medio:{texto:"âš ï¸ Erro na leitura.",tipo:"error"},completo:{texto:"âš ï¸ Ocorreu erro ao abrir o arquivo.",tipo:"error"}},
  pdfAdd:{curto:{texto:"Texto adicionado.",tipo:"success"},medio:{texto:"â• Texto inserido.",tipo:"success"},completo:{texto:"â• Texto do PDF incorporado Ã s observaÃ§Ãµes clÃ­nicas.",tipo:"success"}},
  pdfSemTexto:{curto:{texto:"Sem texto.",tipo:"info"},medio:{texto:"â„¹ï¸ Nada a adicionar.",tipo:"info"},completo:{texto:"â„¹ï¸ NÃ£o hÃ¡ texto disponÃ­vel no PDF para adicionar.",tipo:"info"}}
};

// ==== MOTOR DE TOAST ====
function mostrarMensagem(tipo, nivel = "medio") {
  const dado = mensagens[tipo]?.[nivel];
  if (!dado) return;
  const toast = document.createElement("div");
  toast.className = `toast ${dado.tipo}`;
  toast.textContent = dado.texto;
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add("show"), 10);
  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 400);
  }, 3000);
}
</script>

<script>
(function(){
  'use strict';
  function normalizeSpacing(s){
    if(!s) return '';
    return String(s).replace(/\r\n?/g,'\n')
                    .replace(/[ \t]+/g,' ')
                    .replace(/\n[ \t]+/g,'\n')
                    .replace(/\n{3,}/g,'\n\n')
                    .trim();
  }
  function isMarketingOrContactLine(line){
    const l=(line||'').trim();
    if(!l) return false;
    const tests=[
      /\b(fone|tel|telefone|whats|whatsapp)\b[:\s]?/i,
      /\(?\b\d{2}\)?\s?\d{4,5}[-.\s]?\d{4}\b/,
      /\bcep[:\s]*\d{5}-?\d{3}\b/i,
      /\b(cnpj|c\.?g\.?c|cpf)\b/i,
      /\b(rua|avenida|av\.|rodovia|estrada|praÃ§a|praca|travessa|al\.?)\b/i,
      /(?:https?:\/\/|www\.)\S+/i,
      /\b\S+@\S+\.\S+\b/i,
      /^\s*\d+\s+de\s+\d+\s*$/i,
      /\bagendamento online\b/i,
      /\b(HOSPITAL|UNIDADE DE DIAGNÃ“STICO|RADMAIS|SANTA\s+MARIA|CRUZ\s+ALTA|IJU[IÃ]|SANTO\s+Ã‚NGELO|PANAMBI|SANTO\s+AUGUSTO)\b/i
    ];
    return tests.some(r=>r.test(l));
  }
  function cleanExtractedText(rawText, enabled){
  const t = String(rawText||'').replace(/
?/g,'
');
  return normalizeSpacing(t);
}

    return normalizeSpacing(lines.join('\n'));
  }
  function $(s){return document.querySelector(s);}
  function getToggle(){return $('#filterToggle');}
  function isFilterOn(){const t=getToggle(); return !!(t && t.checked);}
  if(!window.lastText) window.lastText='';
  function hookTextareaFiltering(){
    const ta=$('#pdfContentDisplay');
    if(!ta||!HTMLTextAreaElement||!HTMLTextAreaElement.prototype) return;
    if(ta.__rxiPatched) return;
    const desc=Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype,'value');
    if(!desc||!desc.set||!desc.get) return;
    const origSet=desc.set, origGet=desc.get;
    Object.defineProperty(ta,'value',{
      set(v){
        window.lastText=String(v||'');
        const processed=cleanExtractedText(window.lastText,isFilterOn());
        try{ origSet.call(ta, processed); }catch(e){ ta.textContent=processed; }
        try{ if(typeof window.parseExamText==='function') window.parseExamText(processed); }catch(e){}
      },
      get(){ try{ return origGet.call(ta); }catch(e){ return ta.textContent||''; } }
    });
    ta.__rxiPatched=true;
  }
  function reapplyFilter(){
    const ta=$('#pdfContentDisplay'); if(!ta) return;
    const raw=window.lastText || ta.value || '';
    ta.value=raw;
  }
  function bindToggle(){
    const t=getToggle(); if(!t||t.__rxiBound) return;
    t.addEventListener('change', ()=>{ reapplyFilter(); });
    t.__rxiBound=true;
  }
  function domReady(cb){ if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', cb); } else { cb(); } }
  domReady(()=>{ try{ hookTextareaFiltering(); bindToggle(); }catch(e){} });
})();
</script>

<!-- VLibras -->
<script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
<script> new window.VLibras.Widget('https://vlibras.gov.br/app'); </script>
</body>
</html>
