<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RXIA • Diagnóstico do Índice (JSON)</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --roxo:#64376e; --lilas:#9169a5;
      --bg:#fff; --text:#222; --muted:#f6f3f8; --bd:#e7e2ec;
      --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
      --shadow:0 6px 20px rgba(100,55,110,.10);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    .logo{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--roxo),var(--lilas));box-shadow:var(--shadow)}
    h1{font-size:1.25rem;margin:0}
    .meta{color:#555}
    .card{background:#fff;border:1px solid var(--bd);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="text"], input[type="search"]{
      flex:1;min-width:260px;padding:12px;border:1px solid var(--bd);border-radius:12px;font-size:1rem;outline:none;background:#fff
    }
    button{padding:12px 16px;border-radius:12px;border:0;cursor:pointer;font-weight:600;background:var(--roxo);color:#fff;box-shadow:var(--shadow)}
    button.secondary{background:#fff;color:var(--roxo);border:1px solid var(--bd)}
    .status{display:flex;gap:10px;align-items:center;margin-top:10px;font-size:.95rem}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.loading{background:var(--warn)}
    .dot.ok{background:var(--ok)}
    .dot.err{background:var(--err)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--muted);border:1px solid var(--bd);font-size:.8rem;color:#555;margin:0 6px 6px 0}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-6{grid-column: span 6}
    .col-12{grid-column: span 12}
    .alert{padding:12px 14px;border-radius:12px;border:1px solid var(--bd);background:#fff8f0}
    .alert.ok{background:#f3fff5;border-color:#d5f5df}
    .alert.err{background:#fff1f1;border-color:#ffd0d0}
    .mono{font-family:var(--mono)}
    .list{border:1px solid var(--bd);border-radius:12px;overflow:hidden}
    .item{padding:12px 14px;border-top:1px dashed var(--bd)}
    .item:first-child{border-top:0}
    .k{font-weight:600}
    .kv{font-family:var(--mono);color:#444}
    .kv pre{margin:6px 0 0 0;white-space:pre-wrap}
    details>summary{cursor:pointer;font-weight:600}
    .kbd{font-family:var(--mono);background:#f5f5f5;border:1px solid #e5e5e5;border-radius:6px;padding:2px 6px}
    a{color:var(--roxo);text-decoration:none}
    .footer{color:#666;font-size:.9rem}
    .small{font-size:.9rem;color:#555}
    .tbl{width:100%;border-collapse:collapse;border:1px solid var(--bd);border-radius:12px;overflow:hidden}
    .tbl th,.tbl td{padding:10px;border-bottom:1px solid var(--bd);text-align:left;font-size:.95rem}
    .tbl th{background:#faf8fc}
    .tbl tr:last-child td{border-bottom:0}
    mark{background:#ffef9f;padding:0 2px;border-radius:2px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>RXIA • Diagnóstico do Índice (JSON)</h1>
        <div class="meta">Verificador de caminho, JSON e “shape” esperado pelo widget de busca.</div>
      </div>
    </header>

    <div class="card">
      <div class="row">
        <input id="idx" type="text" placeholder="Nome do índice (ex.: rxi_index.json)" />
        <input id="ver" type="text" placeholder="Cache-buster v (ex.: 1)" />
        <button id="btnLoad">Carregar índice</button>
        <button id="btnThis" class="secondary" title="Usar query string atual">Usar ?index / ?v</button>
      </div>
      <div class="status" id="status">
        <span class="dot loading" id="dot"></span>
        <span id="msg">Aguardando…</span>
      </div>
      <div style="margin-top:8px" class="small">
        Dica: você pode abrir com <span class="kbd">?index=rxi_index.cleaned.pruned.json&v=2</span>.
      </div>
    </div>

    <div class="grid">
      <div class="col-6">
        <div class="card">
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">
            <span class="pill" id="pUrl">índice: –</span>
            <span class="pill" id="pCount">itens: –</span>
            <span class="pill" id="pShape">shape: –</span>
            <span class="pill" id="pFields">campos-chave ok: –</span>
            <span class="pill" id="pMissing">faltantes: –</span>
          </div>
          <div id="boxSummary" class="alert">Sem dados.</div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px 0;font-size:1rem">Amostras (até 5 primeiros)</h3>
          <div id="samples" class="list mono small">
            <div class="item">Sem dados.</div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px 0;font-size:1rem">Prévia bruta (início do arquivo)</h3>
          <details>
            <summary>Mostrar/ocultar</summary>
            <pre id="rawPreview" class="mono" style="white-space:pre-wrap;margin-top:10px;max-height:320px;overflow:auto;border:1px solid var(--bd);border-radius:10px;padding:10px;background:#fafafa">–</pre>
          </details>
        </div>
      </div>

      <div class="col-6">
        <div class="card">
          <h3 style="margin:0 0 8px 0;font-size:1rem">Chaves por item (frequência)</h3>
          <table class="tbl" id="keysTbl">
            <thead><tr><th>Chave</th><th>Itens com a chave</th><th>%</th></tr></thead>
            <tbody><tr><td>–</td><td>–</td><td>–</td></tr></tbody>
          </table>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px 0;font-size:1rem">Campos essenciais e mapeamento</h3>
          <div class="small" style="margin-bottom:8px">
            O widget espera <mark>title</mark>, <mark>citation</mark> e <mark>text</mark>.  
            Este diagnóstico mostra também alternativas encontradas (ex.: <i>content</i>, <i>body</i>).
          </div>
          <table class="tbl" id="mapTbl">
            <thead><tr><th>Campo esperado</th><th>Encontrado (variações)</th><th>Status</th></tr></thead>
            <tbody>
              <tr><td>title</td><td id="mTitle">–</td><td id="sTitle">–</td></tr>
              <tr><td>citation</td><td id="mCitation">–</td><td id="sCitation">–</td></tr>
              <tr><td>text</td><td id="mText">–</td><td id="sText">–</td></tr>
            </tbody>
          </table>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px 0;font-size:1rem">Erros e avisos</h3>
          <div id="log" class="list mono small">
            <div class="item">Sem mensagens.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="wrap" style="padding:0">
      <div class="card footer">
        Se estiver tudo verde aqui e o <b>rxi_widget.html</b> continuar travado em “Carregando índice…”, verifique:
        caminho/arquivo correto, JSON sem vírgulas finais, e o parâmetro <span class="kbd">?v=</span> alinhado.
      </div>
    </div>
  </div>

  <script>
  // ===== Util =====
  const $ = (s)=>document.querySelector(s);
  const $tb = (s)=>document.getElementById(s);
  const qs = new URLSearchParams(location.search);
  const getParam = (k)=>qs.get(k);
  const esc = (s)=>String(s).replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));

  function setStatus(kind,text){ $('#dot').className='dot '+(kind||'loading'); $('#msg').textContent=text||''; }
  function addLog(txt, kind){
    const log = $('#log');
    if(log && log.firstElementChild && log.firstElementChild.textContent==='Sem mensagens.'){ log.innerHTML=''; }
    const div = document.createElement('div');
    div.className='item';
    div.innerHTML = (kind==='err' ? '❌ ' : kind==='warn' ? '⚠️ ' : 'ℹ️ ') + esc(txt);
    log.appendChild(div);
  }

  function percent(n, d){ if(!d) return '0%'; return ((n*100/d).toFixed(1))+'%'; }

  function toArray(raw){
    if(Array.isArray(raw)) return raw;
    if(raw && Array.isArray(raw.chunks)) return raw.chunks;
    if(raw && Array.isArray(raw.items)) return raw.items;
    return [];
  }

  function normalize(item){
    return {
      id: item.id ?? item.doc_id ?? '',
      title: item.title ?? item.document_title ?? '',
      year: item.year ?? item.date_year ?? '',
      page_start: item.page_start ?? item.page ?? item.start ?? '',
      page_end: item.page_end ?? item.end ?? '',
      citation: item.citation ?? item.source ?? '',
      text: item.text ?? item.content ?? item.body ?? '',
      source_file: item.source_file ?? item.file ?? ''
    };
  }

  // ===== DOM refs =====
  const pUrl = $('#pUrl'), pCount=$('#pCount'), pShape=$('#pShape'), pFields=$('#pFields'), pMissing=$('#pMissing');
  const boxSummary = $('#boxSummary'), rawPreview = $('#rawPreview');
  const keysTbl = $('#keysTbl').querySelector('tbody');
  const mapTitle = $('#mTitle'), mapCitation=$('#mCitation'), mapText=$('#mText');
  const sTitle = $('#sTitle'), sCitation=$('#sCitation'), sText=$('#sText');
  const samples = $('#samples');

  // ===== Load flow =====
  async function loadIndex(idxName, v){
    const INDEX_URL = `./${idxName}?v=${encodeURIComponent(v)}`;
    $('#idx').value = idxName;
    $('#ver').value = v;
    pUrl.textContent = `índice: ${INDEX_URL}`;
    setStatus('loading','Carregando índice…');

    try{
      const resp = await fetch(INDEX_URL, { cache:'no-store' });
      if(!resp.ok){
        setStatus('err','Falha no carregamento');
        addLog(`Falha HTTP: ${resp.status} ${resp.statusText} — verifique nome/caminho.`, 'err');
        boxSummary.className = 'alert err';
        boxSummary.innerHTML = '<b>Erro:</b> não foi possível baixar o índice (HTTP '+resp.status+').';
        return;
      }

      const text = await resp.text();
      rawPreview.textContent = text.slice(0, 4000) + (text.length>4000?'…':'');

      let data;
      try{
        data = JSON.parse(text);
      } catch (e){
        setStatus('err','JSON inválido');
        addLog(`JSON inválido: ${e.message}`, 'err');
        boxSummary.className = 'alert err';
        boxSummary.innerHTML = '<b>Erro:</b> JSON inválido. Verifique vírgulas finais e aspas.';
        return;
      }

      // Shape
      const arrRaw = toArray(data);
      pShape.textContent = Array.isArray(data) ? 'array (raiz)' :
                           (data && Array.isArray(data.chunks)) ? 'objeto.chunks' :
                           (data && Array.isArray(data.items)) ? 'objeto.items' :
                           'desconhecido';

      if(!arrRaw.length){
        setStatus('warn','Índice vazio/shape incompatível');
        boxSummary.className = 'alert';
        boxSummary.innerHTML = 'Índice carregado, porém <b>sem itens</b> ou com <b>shape</b> incompatível.';
        addLog('Nenhum item encontrado no array.', 'warn');
        keysTbl.innerHTML = '<tr><td colspan="3">Sem itens para analisar.</td></tr>';
        samples.innerHTML = '<div class="item">Sem dados.</div>';
        pCount.textContent = 'itens: 0';
        pFields.textContent = 'campos-chave ok: 0/0';
        pMissing.textContent = 'faltantes: –';
        return;
      }

      // Estatísticas de chaves
      const freq = new Map();
      const REQUIRED = ['title','citation','text'];
      const ALIASES = { title:['title','document_title'],
                        citation:['citation','source'],
                        text:['text','content','body'] };

      arrRaw.forEach(it=>{
        Object.keys(it).forEach(k=>{
          freq.set(k, (freq.get(k)||0)+1);
        });
      });

      // Render tabela de chaves
      const total = arrRaw.length;
      const sorted = Array.from(freq.entries()).sort((a,b)=>b[1]-a[1]);
      keysTbl.innerHTML = sorted.map(([k,c])=>`<tr><td>${esc(k)}</td><td>${c}</td><td>${percent(c,total)}</td></tr>`).join('');

      // Mapeamento esperado
      function foundAny(keys){ return keys.filter(k=>freq.has(k)); }
      const fTitle = foundAny(ALIASES.title);
      const fCite  = foundAny(ALIASES.citation);
      const fText  = foundAny(ALIASES.text);
      mapTitle.innerHTML = fTitle.length ? fTitle.map(esc).join(', ') : '<i>não encontrado</i>';
      mapCitation.innerHTML = fCite.length ? fCite.map(esc).join(', ') : '<i>não encontrado</i>';
      mapText.innerHTML = fText.length ? fText.map(esc).join(', ') : '<i>não encontrado</i>';
      sTitle.textContent = fTitle.length ? 'OK' : 'faltando';
      sCitation.textContent = fCite.length ? 'OK' : 'faltando';
      sText.textContent = fText.length ? 'OK' : 'faltando';

      // Normalização p/ medir faltantes por item
      const arr = arrRaw.map(normalize);
      let missing = 0;
      arr.forEach(r=>REQUIRED.forEach(k=>{ if(!r[k]) missing++; }));

      // Resumo
      pCount.textContent   = `itens: ${arr.length}`;
      pFields.textContent  = `campos-chave ok: ${(arr.length*REQUIRED.length-missing)}/${arr.length*REQUIRED.length}`;
      pMissing.textContent = `faltantes: ${missing}`;
      boxSummary.className = 'alert ok';
      boxSummary.innerHTML = `
        <b>Sucesso:</b> índice carregado.<br>
        Itens: <b>${arr.length}</b>. Campos essenciais analisados: <b>${REQUIRED.join(', ')}</b>.<br>
        Se o widget de busca ainda travar, alinhe o nome/shape do arquivo com o mapeamento acima.
      `;
      setStatus('ok','Índice carregado.');

      // Amostras
      const N = Math.min(5, arr.length);
      samples.innerHTML = '';
      for(let i=0;i<N;i++){
        const r = arr[i];
        const txt = (r.text || '').slice(0, 400).replace(/\s+/g,' ');
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `
          <div><span class="k">#${i+1}</span> • <span class="k">title:</span> <span class="kv">${esc(r.title||'')}</span></div>
          <div><span class="k">citation:</span> <span class="kv">${esc(r.citation||'')}</span></div>
          <details style="margin-top:6px"><summary>texto (prévia)</summary><pre class="mono"><code>${esc(txt)}${(r.text||'').length>400?'…':''}</code></pre></details>
          ${r.source_file ? `<div class="small" style="margin-top:6px">arquivo: <span class="kv">${esc(r.source_file)}</span></div>` : ''}
        `;
        samples.appendChild(item);
      }

      // Alertas úteis
      if(!fText.length){
        addLog('Campo de texto não encontrado com nomes conhecidos (text/content/body). O widget não conseguirá ranquear.', 'warn');
      }
      if(arr.length && missing > 0){
        addLog(`Existem ${missing} campos essenciais ausentes somando todos os itens (title/citation/text).`, 'warn');
      }
      if(!fTitle.length) addLog('O campo de título não foi reconhecido (title/document_title).', 'warn');
      if(!fCite.length)  addLog('O campo de citação não foi reconhecido (citation/source).', 'warn');

    } catch (e){
      setStatus('err','Falha inesperada');
      addLog('Exceção: '+(e && e.message ? e.message : String(e)), 'err');
      boxSummary.className = 'alert err';
      boxSummary.innerHTML = '<b>Erro:</b> exceção não tratada. Ver console.';
    }
  }

  // ===== Boot/UI =====
  function initFromQS(){
    const idx = getParam('index') || 'rxi_index.json';
    const v = getParam('v') || '1';
    $('#idx').value = idx;
    $('#ver').value = v;
    loadIndex(idx, v);
  }

  $('#btnLoad').addEventListener('click', ()=>{
    const idx = ($('#idx').value||'').trim() || 'rxi_index.json';
    const v   = ($('#ver').value||'').trim() || '1';
    loadIndex(idx, v);
  });
  $('#btnThis').addEventListener('click', initFromQS);

  // auto
  initFromQS();
  </script>
</body>
</html>
