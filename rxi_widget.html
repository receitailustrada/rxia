<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RXI ‚Ä¢ Widget de Busca (Resgate v1.1)</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --roxo:#64376e; --lilas:#9169a5; --bg:#fff; --text:#222; --muted:#f6f3f8; --bd:#e8e2ec;
    --ok:#16a34a; --warn:#f59e0b; --err:#dc2626; --shadow:0 6px 20px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 Montserrat,system-ui,sans-serif}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 12px}
  .card{background:#fff;border:1px solid var(--bd);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin:12px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  input[type="search"]{flex:1;min-width:240px;padding:12px 14px;border:1px solid var(--bd);border-radius:12px;outline:none}
  .pill{display:inline-flex;align-items:center;gap:8px;background:var(--muted);padding:8px 12px;border-radius:999px;font-size:12px}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--roxo);color:#fff;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .stat{font-size:12px;color:#555}
  .result{padding:12px 0;border-top:1px dashed var(--bd)}
  mark{background:#fff3b0}
  .err{color:var(--err);white-space:pre-wrap}
  .meta{font-size:12px;color:#555;margin:6px 0}
  .badge{display:inline-block;font-size:10px;padding:2px 8px;border:1px solid var(--bd);border-radius:999px;margin-left:6px}
  a{color:var(--roxo);text-decoration:none}
  .small{font-size:12px;color:#666}
</style>
</head>
<body>
<div class="wrap">
  <h1>RXI ‚Ä¢ Widget de Busca (Resgate v1.1)</h1>

  <div class="card">
    <div class="row">
      <input id="q" type="search" placeholder="Digite para buscar nos textos (acentos ignorados)..." autocomplete="off"/>
      <button id="clear" class="btn" type="button">Limpar</button>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="pill">√çndice: <code id="idxName">?</code></span>
      <span class="pill">Itens: <b id="count">‚Äì</b></span>
      <span class="pill">Tempo: <b id="took">‚Äì</b></span>
      <span class="stat" id="status"></span>
    </div>
    <div id="error" class="err" style="margin-top:8px"></div>
  </div>

  <div id="results" class="card" style="display:none">
    <div class="small" id="hint"></div>
    <div id="list"></div>
  </div>
</div>

<script>
(function(){
  const $ = (sel)=>document.querySelector(sel);
  const url = new URL(location.href);
  const indexParam = url.searchParams.get('index') || 'rxi_index.cleaned.pruned.json';
  const vParam = url.searchParams.get('v') || Date.now();
  const indexUrl = indexParam + '?v=' + encodeURIComponent(vParam);
  $('#idxName').textContent = indexParam;

  const state = { data:[], ready:false };

  const t0 = performance.now();
  fetch(indexUrl, { cache:'no-store' })
    .then(async (res)=>{
      if(!res.ok) throw new Error('HTTP ' + res.status + ' ao buscar ' + indexParam);
      let text = await res.text();
      // Remove BOM e caracteres de controle invis√≠veis (preserva \n \r \t)
      text = text.replace(/^\uFEFF/, '').replace(/[\u0000-\u001F\u007F]/g, (m)=>(/[\n\r\t]/.test(m)?m:''));
      let json;
      try{
        json = JSON.parse(text);
      }catch(e){
        throw new Error('JSON inv√°lido: '+e.message.slice(0,300));
      }

      // üëâ Aceita: array raiz, {chunks:[...]}, {documents:[...]}
      const arr = Array.isArray(json) ? json
        : (Array.isArray(json.chunks) ? json.chunks
        : (Array.isArray(json.documents) ? json.documents : null));
      if(!Array.isArray(arr)) throw new Error('Formato inesperado. Use um array, {chunks:[...]} ou {documents:[...]}');

      state.data = arr;

      // Valida√ß√£o leve
      const required = ['title','text'];
      const miss = sampleMissing(state.data, required, 5);
      if(miss.length){
        $('#status').textContent = 'Aviso: itens com campos ausentes ('+miss.join(', ')+')';
      }else{
        $('#status').textContent = '√çndice carregado com sucesso.';
      }
      $('#count').textContent = state.data.length.toLocaleString('pt-BR');
      $('#took').textContent = (performance.now()-t0).toFixed(0)+' ms';
      state.ready = true;
    })
    .catch(err=>{
      $('#error').textContent = [
        'Falha ao carregar o √≠ndice.',
        'URL: ' + indexUrl,
        'Motivo: ' + err.message,
        '',
        'Dicas:',
        '‚Ä¢ Confirme se o arquivo existe exatamente com este nome e caminho (case-sensitive).',
        '‚Ä¢ Hospede o JSON no MESMO dom√≠nio/pasta do widget (evita CORS).',
        '‚Ä¢ Valide o JSON (sem v√≠rgulas sobrando, aspas coerentes, sem coment√°rios).',
        '‚Ä¢ Use ?v=algo para for√ßar recarregar ap√≥s cada push no GitHub Pages.'
      ].join('\n');
    });

  function sampleMissing(arr, required, max){
    const names = new Set();
    for(let i=0;i<arr.length && names.size<max;i++){
      const it = arr[i] || {};
      required.forEach(k=>{ if(!(k in it)) names.add(k); });
    }
    return [...names];
  }

  // Busca com normaliza√ß√£o (acentos, caixa)
  const norm = (s)=> (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').toLowerCase();
  let timer=null;

  $('#q').addEventListener('input', ()=>{ clearTimeout(timer); timer=setTimeout(runSearch,120); });
  $('#clear').addEventListener('click', ()=>{ $('#q').value=''; runSearch(); $('#q').focus(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ runSearch(); } });

  function runSearch(){
    const q = norm($('#q').value.trim());
    if(!state.ready){
      $('#hint').textContent = 'Carregando √≠ndice...';
      $('#results').style.display='block';
      return;
    }
    const t1 = performance.now();
    const list = $('#list'); list.innerHTML='';
    if(!q){
      $('#hint').textContent = 'Digite algo para buscar nos textos.';
      $('#results').style.display='block';
      return;
    }

    const hits = [];
    for(const it of state.data){
      if((norm(it.title).includes(q)) || (norm(it.text).includes(q))){
        hits.push(it);
        if(hits.length>500) break; // protecao
      }
    }
    const took = (performance.now()-t1).toFixed(0);
    $('#hint').textContent = `Mostrando ${hits.length.toLocaleString('pt-BR')} resultado(s) ‚Ä¢ ${took} ms`;

    if(hits.length===0){ $('#results').style.display='block'; return; }

    // Render com suporte a href e id
    const frag = document.createDocumentFragment();
    for(const it of hits){
      const el = document.createElement('div');
      el.className = 'result';

      const title = (it.title || 'Sem t√≠tulo');
      const citation = it.citation ? ` ‚Äî <span class="small">${escapeHTML(it.citation)}</span>` : '';

      const metaParts = [
        it.year!=null ? `Ano: ${escapeHTML(String(it.year))}` : null,
        (it.page_start!=null && it.page_end!=null) ? `pp. ${escapeHTML(String(it.page_start))}‚Äì${escapeHTML(String(it.page_end))}` : null,
        it.source_file ? `Fonte: ${escapeHTML(it.source_file)}` : null,
      ].filter(Boolean);

      if(it.href){
        metaParts.push(`<a class="badge" href="${escapeHTML(it.href)}" target="_blank" rel="noopener">Abrir</a>`);
      }
      const meta = metaParts.join(' ‚Ä¢ ');

      el.innerHTML = `
        <div>
          <b>${highlight(title, q)}</b>${citation}
          ${it.id ? `<span class="badge">ID: ${escapeHTML(String(it.id))}</span>` : ''}
        </div>
        ${meta ? `<div class="meta">${meta}</div>` : ''}
        <div class="small">${highlight((it.text||'').slice(0,1000), q)}${(it.text||'').length>1000?'...':''}</div>
      `;
      frag.appendChild(el);
    }
    list.appendChild(frag);
    $('#results').style.display='block';
  }

  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function highlight(s, q){
    if(!q) return escapeHTML(s||'');
    const raw = s||'';
    const idxs = [];
    const src = (raw).normalize('NFD').replace(/\p{Diacritic}+/gu,'').toLowerCase();
    let pos = 0;
    while(true){
      const i = src.indexOf(q, pos);
      if(i<0) break;
      idxs.push([i, i+q.length]);
      pos = i+q.length;
      if(idxs.length>50) break;
    }
    if(!idxs.length) return escapeHTML(raw);
    let out='', last=0;
    for(const [a,b] of idxs){
      out += escapeHTML(raw.slice(last,a)) + '<mark>' + escapeHTML(raw.slice(a,b)) + '</mark>';
      last = b;
    }
    out += escapeHTML(raw.slice(last));
    return out;
  }
})();
</script>
</body>
</html>
