<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RXIA • Protocolos de encaminhamento GERCON</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#fff; --text:#1f2937; --muted:#f3f4f6; --bd:#e5e7eb;
    --brand:#006fff;   /* cor principal */
    --brand-2:#0a7cff; /* mais clara p/ gradiente */
    --brand-3:#0057d6; /* mais escura p/ gradiente */
    --ok:#16a34a; --warn:#f59e0b;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;
    background:var(--bg); color:var(--text);
  }
  .banner{ background:#eef6ff; border-bottom:1px solid #d6e9ff; padding:.6rem 1rem; color:#083c7a; font-size:.9rem; }
  header{ position:sticky; top:0; background:#fff; border-bottom:1px solid var(--bd); padding:1rem; z-index:10; }
  .container{ max-width:980px; margin:0 auto; padding:1.25rem; }
  h1{ font-size:1.25rem; margin:0 0 .5rem; color:var(--brand); }
  .bar{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }

  /* Campo de pesquisa aumentado */
  input[type="text"]{
    flex:1 0 680px; min-width:320px;
    padding:1.05rem 1.2rem;
    border:1px solid var(--bd);
    border-radius:.75rem;
    outline:0;
    font-size:1.2rem;     /* ~ dois steps acima */
    line-height:1.3;
    transition:border-color .15s, box-shadow .15s;
  }
  input[type="text"]:focus{
    border-color:var(--brand);
    box-shadow:0 0 0 3px rgba(0,111,255,.15);
  }

  /* BOTÃO PRINCIPAL – gradiente #006fff (apenas .primary) */
  button.primary{
    padding:.95rem 1.1rem;
    border:0; border-radius:.75rem;
    color:#fff; font-weight:600; cursor:pointer;
    background: linear-gradient(135deg, var(--brand-2) 0%, var(--brand) 55%, var(--brand-3) 100%);
    box-shadow: 0 6px 16px rgba(0,111,255,.25);
    transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
  }
  button.primary:hover{
    transform: translateY(-1px);
    box-shadow: 0 10px 24px rgba(0,111,255,.28);
    filter: brightness(1.02);
  }
  button.primary:active{
    transform: translateY(0);
    box-shadow: 0 5px 14px rgba(0,111,255,.22);
    filter: brightness(.98);
  }
  button.primary:focus-visible{
    outline: 0;
    box-shadow: 0 0 0 3px rgba(0,111,255,.18), 0 6px 16px rgba(0,111,255,.25);
  }

  /* Botões secundários (escuros) */
  button.secondary{
    background:#111827; color:#fff; border:0; border-radius:.75rem;
    padding:.95rem 1.1rem; box-shadow: 0 6px 16px rgba(0,0,0,.18);
    font-weight:600; cursor:pointer;
    transition: transform .12s ease, box-shadow .12s ease;
  }
  button.secondary:hover{ transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,.22); }
  button.secondary:active{ transform: translateY(0); box-shadow: 0 5px 14px rgba(0,0,0,.18); }

  select{
    padding:.9rem .9rem; border:1px solid var(--bd); border-radius:.75rem; background:#fff;
  }
  .pill{ display:inline-block; padding:.25rem .6rem; border-radius:999px; background:var(--muted); border:1px solid var(--bd); font-size:.75rem; margin-right:.25rem; }
  .card{ background:#fff; border:1px solid var(--bd); border-radius:1rem; padding:1rem; margin:.75rem 0; box-shadow:0 4px 20px rgba(0,0,0,.04); }
  .meta{ font-size:.85rem; color:#374151; display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; margin-bottom:.5rem; }
  .txt{ line-height:1.6; white-space:pre-wrap; }
  .ai{ border-left:6px solid var(--brand); }
  .small{ font-size:.8rem; color:#6b7280; }
  .hi{ background:#fff3b0; }
  .row{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
  .right{ margin-left:auto; }

  /* chips – **não** herdam estilo de button */
  .chips{margin-top:.75rem;display:flex;flex-wrap:wrap;gap:.5rem}
  .chip{
    appearance:none;
    border:1px solid var(--bd);
    background:var(--muted) !important;   /* fundo claro */
    color:var(--text) !important;          /* texto escuro */
    padding:.55rem .8rem;
    border-radius:999px;
    font-size:.9rem;
    cursor:pointer;
    box-shadow:none !important;            /* sem sombra forte */
    text-shadow:none !important;
  }
  .chip:hover{
    border-color:var(--brand);
    box-shadow:0 0 0 3px rgba(0,111,255,.10) !important;
  }

  a{ color:var(--brand); }
</style>
</head>
<body>
<div class="banner">⚠️ <strong>RXIA</strong>: responde apenas com base nos documentos do índice. Não substitui avaliação médica.
  <span style="float:right">Beta (RAG)</span>
</div>

<header>
  <div class="container">
    <h1>RXIA • Pergunte qualquer coisa dos protocolos do TelessaúdeRS</h1>
    <div class="bar">
      <input id="q" type="text" placeholder="Pergunte algo (ex.: 'conduta para BI-RADS 3?')">
      <button id="ask" class="primary">Responder com IA</button>
      <button id="find" class="secondary">Mostrar trechos</button>
      <button id="clear" class="secondary">Limpar</button>

      <!-- seletor de base -->
      <select id="ds" title="Selecionar base do índice">
        <option value="completo">Base: Completo</option>
        <option value="focado">Base: Focado</option>
        <option value="curado">Base: Curado</option>
      </select>
    </div>

    <!-- chips de sugestão -->
    <div class="chips" id="suggestions"></div>

    <div class="small" style="margin-top:.5rem">
      <span id="dsLabel">Carregando…</span>
    </div>
  </div>
</header>

<main class="container">
  <div id="status" class="small">Carregando índice…</div>
  <div id="answer"></div>
  <div id="results"></div>
</main>

<footer class="container small">
  RXIA • MVP client-side (ranqueamento TF-IDF) + servidor Apps Script. Chave segura no backend.
</footer>

<script>
// ======= CONFIG =======
// Cole aqui a URL do seu Apps Script (Web App) — termina com /exec:
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxWSxns05VbUf5677Wx3faATxdoLK9JCxmMnaMdPbdmutPdfhose81OUlIeY70ZL6ee/exec";
const APP_TOKEN   = "rxia_9ZP2-7kQvY";
// URLs das bases (raw GitHub). Ajuste conforme os arquivos que você publicou.
const DATASETS = {
  completo: "https://raw.githubusercontent.com/receitailustrada/rxia/main/rxi_index.json",
  focado:   "https://raw.githubusercontent.com/receitailustrada/rxia/main/rxi_index_focus.json",
  curado:   "https://raw.githubusercontent.com/receitailustrada/rxia/main/rxi_index_curated_focus.json"
};

// Sugestões (label = texto no chip; q = consulta enviada)
const SUGGESTIONS = [
  { label: "Conduta BI-RADS 3", q: "conduta mamografia BI-RADS 3" },
  { label: "ASC-US (rastreamento)", q: "ASC-US rastreamento conduta" },
  { label: "Nódulo <30a", q: "nódulo mamário palpável <30 anos abordagem" },
  { label: "Mastalgia", q: "mastalgia avaliação e manejo" },
  { label: "Intervalo Papanicolau", q: "intervalo rastreamento câncer do colo do útero" },
  { label: "Varicocele", q: "varicocele critérios encaminhamento andrologia" },
  { label: "Infertilidade (exames)", q: "infertilidade masculina exames iniciais encaminhar" },
  { label: "Asma adulto", q: "asma adulto manejo APS critérios de encaminhamento" },
  { label: "Pólipo de vesícula", q: "pólipo de vesícula critérios de encaminhamento" }
];

// Se o backend não estiver configurado, chips mostram 'trechos' em vez de IA
const DEFAULT_ACTION = (BACKEND_URL && !BACKEND_URL.startsWith("PASTE_")) ? 'ai' : 'passages';

// ======= CORE =======
function tokenize(s){
  return (s || "").toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9á-úç\s]/g,' ')
    .split(/\s+/).filter(Boolean);
}

const state = { docs: [], df:{}, N:0, currentDS: "completo" };

function setDSLabel(){
  const map = {completo:"Base: Completo", focado:"Base: Focado", curado:"Base: Curado"};
  document.getElementById('dsLabel').textContent =
    (map[state.currentDS] || "Base") + " • arquivo: " + (DATASETS[state.currentDS] || "?");
}

async function loadIndex(url){
  const statusEl = document.getElementById('status');
  try{
    statusEl.textContent = 'Carregando índice…';
    const res = await fetch(url + '?v=' + Date.now());
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    state.docs = (data && data.documents) ? data.documents : [];
    state.N = state.docs.length;
    const df = {};
    state.docs.forEach(d=>{
      const terms = new Set(tokenize(d.text));
      terms.forEach(t=>{ df[t] = (df[t]||0)+1; });
    });
    state.df = df;
    statusEl.textContent = `Índice carregado: ${state.N} trechos.`;
  }catch(e){
    statusEl.textContent = 'Falha ao carregar o índice ('+e.message+'). Verifique o link/arquivo.';
  }
}

function scoreDoc(doc, qTerms){
  const toks = tokenize(doc.text);
  const tf = {};
  toks.forEach(t=> tf[t] = (tf[t]||0)+1);
  let score = 0;
  qTerms.forEach(q=>{
    const tfq = tf[q] || 0;
    const df = state.df[q] || 1;
    const idf = Math.log((state.N+1) / df);
    score += (tfq > 0 ? (1 + Math.log(tfq)) : 0) * idf;
  });
  return score;
}

function topK(q, k=5){
  const qTerms = tokenize(q).filter(v=>v.length>1);
  const scored = state.docs.map(d=>({d, s:scoreDoc(d, qTerms)}))
    .filter(x=>x.s>0)
    .sort((a,b)=>b.s-a.s)
    .slice(0, k);
  return scored.map(x=>x.d);
}

function highlight(text, terms){
  let out = text;
  terms.forEach(t=>{
    if(!t) return;
    const esc = t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const re = new RegExp(`\\b(${esc})\\b`, 'gi');
    out = out.replace(re, '<span class="hi">$1</span>');
  });
  return out;
}

function showPassages(q){
  const resultsEl = document.getElementById('results');
  resultsEl.innerHTML = '';
  const qTerms = tokenize(q).filter(v=>v.length>1);
  const docs = topK(q, 8);
  if(docs.length===0){
    resultsEl.innerHTML = '<div class="card">Nenhum resultado encontrado nos seus documentos.</div>';
    return;
  }
  docs.forEach(d=>{
    const card = document.createElement('div');
    card.className = 'card';
    const pages = d.page_start + (d.page_end!==d.page_start? '–'+d.page_end : '');
    const meta = `<div class="meta">
      <span class="pill">${d.title}</span>
      <span class="pill">p. ${pages}</span>
      <span class="pill">src: ${d.source_file || '—'}</span>
    </div>`;
    const txt = highlight(d.text.slice(0, 1500), qTerms);
    card.innerHTML = meta + `<div class="txt">${txt}</div>`;
    resultsEl.appendChild(card);
  });
}

async function askLLM(q){
  const ansEl = document.getElementById('answer');
  ansEl.innerHTML = '<div class="card ai">Gerando resposta…</div>';
  const docs = topK(q, 5).map(d=>({
    citation: d.citation,
    title: d.title,
    page_start: d.page_start,
    page_end: d.page_end,
    text: d.text.length>1800 ? (d.text.slice(0, 1800)+'…') : d.text
  }));

  if(!BACKEND_URL || BACKEND_URL.startsWith("PASTE_")){
    ansEl.innerHTML = '<div class="card ai">⚠️ Configure o BACKEND_URL (URL do Apps Script) dentro do arquivo para gerar resposta.</div>';
    return;
  }

  try{
    // >>> Passo 1 aplicado: sem headers para evitar preflight CORS <<<
    const res = await fetch(BACKEND_URL, {
      method: 'POST',
      body: JSON.stringify({ question: q, contexts: docs })
    });
    if(!res.ok){
      const t = await res.text();
      throw new Error('HTTP '+res.status+': '+t);
    }
    const data = await res.json();
    const text = (data && data.answer) ? data.answer : 'Sem resposta';
    const cites = docs.map(d=>'• '+d.citation).join('<br>');
    ansEl.innerHTML = `<div class="card ai">
        <div class="meta"><span class="pill">Resposta (IA)</span><span class="pill right">${state.currentDS}</span></div>
        <div class="txt">${text}</div>
        <div class="small" style="margin-top:.5rem"><strong>Fontes:</strong><br>${cites}</div>
      </div>`;
  }catch(e){
    ansEl.innerHTML = '<div class="card ai">❌ Erro ao consultar a IA: '+e.message+'</div>';
  }
}

// ======= UI wiring =======
document.getElementById('ask').addEventListener('click', ()=>{
  const q = document.getElementById('q').value.trim();
  if(!q) return;
  document.getElementById('answer').innerHTML = '';
  document.getElementById('results').innerHTML = '';
  askLLM(q);
});
document.getElementById('find').addEventListener('click', ()=>{
  const q = document.getElementById('q').value.trim();
  if(!q) return;
  document.getElementById('answer').innerHTML = '';
  document.getElementById('results').innerHTML = '';
  showPassages(q);
});
document.getElementById('clear').addEventListener('click', ()=>{
  document.getElementById('q').value = '';
  document.getElementById('answer').innerHTML = '';
  document.getElementById('results').innerHTML = '';
});
document.getElementById('q').addEventListener('keydown', e=>{
  if(e.key==='Enter'){ document.getElementById('ask').click(); }
});

// chips
function renderSuggestions(){
  const box = document.getElementById('suggestions');
  if(!box) return;
  box.innerHTML = '';
  SUGGESTIONS.forEach(s=>{
    const b = document.createElement('button');
    b.className = 'chip'; b.type='button'; b.textContent = s.label;
    b.addEventListener('click', ()=>{
      const qEl = document.getElementById('q'); qEl.value = s.q;
      (DEFAULT_ACTION === 'ai' ? askLLM : showPassages)(s.q);
    });
    box.appendChild(b);
  });
}

// datasets
async function loadForSelection(){
  const sel = document.getElementById('ds');
  const val = sel.value || 'completo';
  state.currentDS = val;
  setDSLabel();
  await loadIndex(DATASETS[val]);
}
document.getElementById('ds').addEventListener('change', loadForSelection);

// bootstrap + query params (?q=...&a=ai|passages&ds=curado)
(function(){
  renderSuggestions();
  const p = new URLSearchParams(location.search);
  const ds = p.get('ds');
  if(ds && DATASETS[ds]){ document.getElementById('ds').value = ds; state.currentDS = ds; }
  setDSLabel();
  loadForSelection().then(()=>{
    const q = p.get('q'); const a = p.get('a') || (DEFAULT_ACTION);
    if(q){
      document.getElementById('q').value = q;
      (a==='passages' ? showPassages : askLLM)(q);
    }
  });
})();
</script>
</body>
</html>
